{
    "version": "https://jsonfeed.org/version/1",
    "title": "Uveta's blog • All posts by \"dotnet\" tag",
    "description": "Uveta's blog about all things Azure",
    "home_page_url": "https://www.uveta.io",
    "items": [
        {
            "id": "https://www.uveta.io/categories/blog/github-workflow-unity-azure-static-webapps/",
            "url": "https://www.uveta.io/categories/blog/github-workflow-unity-azure-static-webapps/",
            "title": "Using GitHub workflow to deploy Unity project to Azure Static Web Apps",
            "date_published": "2022-12-19T10:17:46.000Z",
            "content_html": "<html><head></head><body><img src=\"/categories/blog/github-workflow-unity-azure-static-webapps/github.jpg\" class=\"\" title=\"GitHub\">\n\n<p>This post explains how to create a GitHub workflow, which builds, tests and deploys a Unity project to Azure Static Web Apps (SWA) instance. Due to foundations on which SWA was built upon, it represents a perfect way to develop and test any game built on Unity WebGL platform.</p>\n<span id=\"more\"></span>\n\n<p><em>This post is part of <strong>.NET Advent 2022!</strong> Check other great entries <a href=\"https://dotnet.christmas/\">here</a>.</em></p>\n<h2 id=\"Introduction\"><a href=\"#Introduction\" class=\"headerlink\" title=\"Introduction\"></a>Introduction</h2><p>I created this workflow as a part of another activity. It involved remastering Hungry Square, a game I once developed, into Unity. If you want to have the whole context, check out <a href=\"../unity-in-21-days\">my other post, about how I learned Unity in 21 days</a>.</p>\n<h2 id=\"CI-CD-Pipeline\"><a href=\"#CI-CD-Pipeline\" class=\"headerlink\" title=\"CI/CD Pipeline\"></a>CI/CD Pipeline</h2><p>Forget that we are actually working with Unity. Lets consider our game project just another web application. A well-established way to write a web app CI/CD pipeline is to break it into three steps: project build, infrastructure deploy, and application bundle deploy. Lets take a deeper look into each one.</p>\n<h3 id=\"Building-and-testing-Unity-project\"><a href=\"#Building-and-testing-Unity-project\" class=\"headerlink\" title=\"Building and testing Unity project\"></a>Building and testing Unity project</h3><p>We’re starting off in uncharted territory, at least for me. Building Unity projects was something I was not too familiar with. Luckily, good folks at <a href=\"https://game.ci/docs/\">game.ci</a> provide a convenient way how to work with Unity games, in GitHub environment. Setting up a build job is straightforward, and involves following steps:</p>\n<ul>\n<li>Ensure Unity license, username, and password are provided to workflow, via GitHub secrets. Details on activating license and setting up secrets, depending on license type, can be found in <a href=\"https://game.ci/docs/github/activation\">game.ci documentation</a></li>\n<li>Run any tests in project using <a href=\"https://game.ci/docs/github/test-runner\">game-ci/unity-test-runner</a> action.</li>\n<li>Build project for all configured platforms using <a href=\"https://game.ci/docs/github/builder\">game-ci/unity-builder</a> action.</li>\n<li>Optionally, use <a href=\"https://github.com/actions/cache\">actions/cache</a> action to cache dynamic project files. This often reduces build time dramatically.</li>\n<li>Finally, make build output available to succeeding jobs via <a href=\"https://github.com/actions/upload-artifact\">actions/upload-artifact</a>.</li>\n</ul>\n<script src=\"https://gist.github.com/uveta/16b5583b4d2961cd16994404320f1f10.js\"></script>\n\n<p>If all steps have finished without an error, we should end up with an artifact containing our application bundle.</p>\n<h3 id=\"Infrastructure\"><a href=\"#Infrastructure\" class=\"headerlink\" title=\"Infrastructure\"></a>Infrastructure</h3><p>When setting up this type of projects, we should make no assumptions about existing deployment environment. It is why I have included a job to create all necessary infrastructure. There is an abundance of ways how to programmatically deploy to Azure (CLI, PowerShell, Terraform, etc.), each one with its pros and cons. In our case, the optimal way was using Bicep domain-specific language, which offers a good balance between complexity, robustness and extensibility. For this purpose, we will deploy a resource group, in which a SWA instance will be created. All necessary templates can be found in <a href=\"https://github.com/uveta/hungry-square-unity/tree/main/infra\">./infra</a> directory.</p>\n<p>As with almost all actions in Azure, Bicep deployment has to be preceded with an Azure login step. Detailed instructions on how to setup subscription identifier and login credentials, using GitHub secrets, can be found in <a href=\"https://github.com/Azure/login\">Azure login action documentation</a>. Subsequent Bicep deployment is done using <a href=\"https://github.com/Azure/arm-deploy\">azure/arm-deploy</a> action.</p>\n<script src=\"https://gist.github.com/uveta/c4542f2218751bb128ffa48b4106c06d.js\"></script>\n\n<h3 id=\"Deploying-to-Azure-Static-Web-Apps\"><a href=\"#Deploying-to-Azure-Static-Web-Apps\" class=\"headerlink\" title=\"Deploying to Azure Static Web Apps\"></a>Deploying to Azure Static Web Apps</h3><p>Deployment of application bundle to a SWA instance consists of two steps (or four if you are nitpicking and want to include artifact download and Azure login). Prior to actual upload, a deployment token for SWA must be obtained. We will use <a href=\"https://github.com/Azure/cli\">Azure CLI</a> to get it and store it in a job environment variable <em>SWA_DEPLOYMENT_TOKEN</em>.</p>\n<p>Uploading build output to SWA is done using <a href=\"https://github.com/Azure/static-web-apps-deploy\">azure/static-web-apps-deploy</a> action. In our case, following parameters have to be included:</p>\n<ul>\n<li><strong>azure_static_web_apps_api_token</strong>, a deployment token obtained in previous step</li>\n<li><strong>repo_token</strong>, a GitHub token with appropriate permissions, which action will use to provide URL to access our application</li>\n<li><strong>app_location</strong>, directory or file to upload to SWA, which is in our case <em>./build/WebGL/WebGL</em></li>\n</ul>\n<script src=\"https://gist.github.com/uveta/00d40c2d5ddae36762a05cb0b1f8fe94.js\"></script>\n\n<h3 id=\"Bonus-environment-tear-down\"><a href=\"#Bonus-environment-tear-down\" class=\"headerlink\" title=\"Bonus (environment tear down)\"></a>Bonus (environment tear down)</h3><p>After a pull request is merged or abandoned, and a feature branch was deleted, it is appropriate to clean up associated SWA environment. This can easily be done via <a href=\"https://github.com/uveta/hungry-square-unity/blob/main/.github/workflows/teardown.yaml\">tear down workflow</a>, which also uses <a href=\"https://github.com/Azure/static-web-apps-deploy\">SWA action</a>. Similar to code upload, a deployment token has to be obtained first. Afterwards, an SWA action with action parameter set to <em>close</em> is executed, which will remove environment associated with current git branch.</p>\n<script src=\"https://gist.github.com/uveta/6438618e956a75217f42915bd007a6fd.js\"></script>\n\n<h2 id=\"Final-thoughts\"><a href=\"#Final-thoughts\" class=\"headerlink\" title=\"Final thoughts\"></a>Final thoughts</h2><p>After spending couple of days, making sure that the project is built and deployed properly, I can give you some tips to make designing your future workflow more smooth:</p>\n<ul>\n<li>Make sure you add <em>.gitattributes</em> with proper Git LFS definitions early, ideally before including any asset. Although git makes migration of committed assets to LFS super convenient, it requires rewriting branch history and force pushing it. Not something you really want to do, if you have a whole team collaborating on a project.</li>\n<li>Unity build action will fail, if source files were modified after checkout. As a last resort, you can force execution of a dirty build, using <em>game-ci/unity-builder</em> action parameters.</li>\n<li>Double-check all included scenes in Unity Editor, in File-&gt;Build Settings-&gt;Scenes In Build. In case of any issue with scenes, build error will not help you much.</li>\n<li>It might not be clear what is the correct path of application bundle in build artifact, as it is located under a couple of levels of directories. Verify path by manually downloading artifact bundle, and adjust <em>app_location</em> parameter of <em>azure/static-web-apps-deploy</em> step accordingly.</li>\n</ul>\n<h2 id=\"Conclusion\"><a href=\"#Conclusion\" class=\"headerlink\" title=\"Conclusion\"></a>Conclusion</h2><p>There you have it, a workflow to help you get any Unity WebGL project up and running in minutes. You can check out the final CI/CD workflow <a href=\"https://github.com/uveta/hungry-square-unity/blob/main/.github/workflows/ci.yaml\">here</a>.</p>\n</body></html>",
            "tags": [
                "azure",
                "advanced",
                "dotnet",
                "unity",
                "github",
                "devops"
            ]
        },
        {
            "id": "https://www.uveta.io/categories/blog/unity-in-21-days/",
            "url": "https://www.uveta.io/categories/blog/unity-in-21-days/",
            "title": "Unity in 21 days",
            "date_published": "2022-12-19T10:17:32.000Z",
            "content_html": "<html><head></head><body><img src=\"/categories/blog/unity-in-21-days/pixelart.jpg\" class=\"\" title=\"Pixel Art\">\n\n<p>The title might be a bit misleading. If you assumed this post would be yet another Unity tutorial, it is not quite the case. Teaching you complex framework, such as Unity, in just about three weeks, is something I could never promise. It is more of a story of how I rewrote my high school project, written in Turbo Pascal, without having any real experience with Unity. Because, why not. And I have been postponing learning a thing or two about Unity for quite some time.</p>\n<span id=\"more\"></span>\n\n<p><em>This post is part of <a href=\"https://www.csadvent.christmas/\">C# Advent Calendar 2022</a>. Cheers to <a href=\"https://twitter.com/CsAdvent\">C# Advent</a> for letting me participate!</em></p>\n<h2 id=\"Introduction\"><a href=\"#Introduction\" class=\"headerlink\" title=\"Introduction\"></a>Introduction</h2><p>It has been so long since high school that, once I decided to go down this path, I had no chance to retrieve original game I developed, including source code. All I had was a fond memory of a game called Hungry Square, and a vague image of how the game looked like. It was as simple as it gets. You are a square on a two-dimensional plane, that can move in any of the four directions. Food is spawned randomly around game area. Once the square eats it, game would speed up, and an enemy would pop up and start bouncing around the screen. The objective of Hungry Square is to eat as much food as you can, without being hit by an enemy or colliding with the edge of the screen. Quite simple, right? It is the exact reason why I chose this project to fiddle with Unity.</p>\n<p>If you want to skip the story, and jump straight into the game, you can do so <a href=\"https://red-plant-049cdf903.2.azurestaticapps.net/\">here</a>.</p>\n<h2 id=\"Day-1\"><a href=\"#Day-1\" class=\"headerlink\" title=\"Day 1\"></a>Day 1</h2><p>There is always one question, when trying to learn a topic that you know nothing about: where to even start? Good tutorial goes a long way, and this has been a mantra that I have been using successfully through the years. Just finding one and flipping through it should help get our feet on the ground, and build from there on. In Unity’s case, I have found a nice <a href=\"https://blog.sentry.io/2022/03/21/unity-tutorial-what-you-need-to-know-before-developing-your-first-unity-game\">four-parter on Sentry.io blog</a>, going from basics of installing necessary tools, all the way to publishing finished game to Google Play Store. Lets get to reading!</p>\n<h2 id=\"Day-2\"><a href=\"#Day-2\" class=\"headerlink\" title=\"Day 2\"></a>Day 2</h2><p>Took me two days to read through all four posts and, although I haven’t tried a single part of tutorial, I already feel more confident with whole endeavor. As I got familiar with Unity capabilities, a project manager in me already wants to establish some goals. I must remaster original game, and enhance it as much as possible. Since original offered pretty bare-bones experience, some animations and sounds would round it up nicely. As with almost everything I do these days, remaster should be available to play from web browser. I should try to add an Android version as well.</p>\n<h2 id=\"Day-3\"><a href=\"#Day-3\" class=\"headerlink\" title=\"Day 3\"></a>Day 3</h2><p>Finally installed and ran <a href=\"https://unity.com/downloads\">Unity Hub and Editor</a>. I ignore available samples and create an empty project, using 2D template. It takes approximately seven minutes to create a new project, and another three just to build it for a WebGL platform. Hopefully further development will not take that much time. For a project without a single asset or line of code, build produced a 2.5 Mb large WebAssembly bundle. Not great, not terrible.</p>\n<h2 id=\"Day-4\"><a href=\"#Day-4\" class=\"headerlink\" title=\"Day 4\"></a>Day 4</h2><p>I start by trying to create a simple scene with a bordered background. After spending couple of hours, my initial confidence subsides. Once I started using Unity Editor, I was quickly overwhelmed with number of concepts, windows, and options. Maybe this project will not be a matter of just couple of days, as I initially thought.</p>\n<h2 id=\"Day-5\"><a href=\"#Day-5\" class=\"headerlink\" title=\"Day 5\"></a>Day 5</h2><p>Still trying to add background, but there is almost no progress. Looks like I’ll have to reconsider learning on the fly, and actually dive more deeper into basic  Unity concepts. That said, quick search through <a href=\"https://learn.unity.com/\">Unity’s learn portal</a> reveals <a href=\"https://learn.unity.com/project/ruby-s-2d-rpg\">Ruby’s Adventure</a>, a tutorial on building 2D game. Decided to give it a try, as it covers all the parts I will probably need.</p>\n<p>First chapter explains basic parts of Unity Editor. I learned what all windows are used for, and how to switch between scene and play mode. Next one covers adding game objects and manipulating camera. Managed to add player object (Ruby) and define it’s health.</p>\n<p><em>Hint: if you are not seeing camera bounds in scene, select camera object and assign MainCamera tag to it.</em></p>\n<h2 id=\"Day-6\"><a href=\"#Day-6\" class=\"headerlink\" title=\"Day 6\"></a>Day 6</h2><p>Learning more about keyboard input and how to use it to move game objects. I found out there is old and new input system, but cannot tell what the difference is. Decided to stick with the old one, as it is used in Ruby’s Adventure.</p>\n<p>Next up is drawing background tiles and creating world map. Quite intuitive and quite easy to do, assuming you have the right assets. One thing I noticed is that this part of tutorial is pretty outdated, compared to current Unity version. With tutorial being barely two years old, things seem to be moving at a rapid pace in Unity world!</p>\n<h2 id=\"Day-7\"><a href=\"#Day-7\" class=\"headerlink\" title=\"Day 7\"></a>Day 7</h2><p>Following couple of chapters dealt with game object visibility and physics system. I learned how to order overlapping objects and what a pivot is. I am not sure I will use this knowledge when working on Hungry Square, as there is almost no overlapping between game elements. However, I also learned how to create prefabs, which are used as templates for objects in scene. When thinking about enemies and food, which are added to scene dynamically, prefabs seem like a natural way how to implement them.</p>\n<p>When it comes to physics, Unity’s system revolves around rigid body and collider components, which are used to model and detect game object interactions. Not sure I will ever utilize these components.</p>\n<p><em>Note from Day 11: rigid body and collider are essential components for Hungry Square remaster. They are extensively used to detect interactions between player, food and enemies, as well as model enemy movement in game world. And I thought I would never use them…</em></p>\n<h2 id=\"Day-8\"><a href=\"#Day-8\" class=\"headerlink\" title=\"Day 8\"></a>Day 8</h2><p>Next tutorial chapter taught me how to add moving enemies to the scene, and how to detect when a player collides with them. Learned how to create animations, using sprites, controllers and state machines. Animated movement of both player and enemies, for extra polish. After all, no one likes static objects. As a next step, I added projectiles, so the player can defend against enemies. Learned about collision layers, which made sure projectiles collide only with enemies.</p>\n<p>One small thing that tutorial also went through is moving from a static camera, to one that will follows player. As I plan to have a single screen as playable area, I might not need this type of camera. Will keep it in reserve anyways.</p>\n<p>Following part taught me how to make the game even more visually appealing, by using particles. Utilized them to create smoke effect on enemies. I might need them if I decide to go for extra polish for my remaster. One example would be adding particle effects on food and enemy spawn.</p>\n<h2 id=\"Day-9\"><a href=\"#Day-9\" class=\"headerlink\" title=\"Day 9\"></a>Day 9</h2><p>Nearing the end of tutorial. This chapter showed me how to create scene overlay, which will be used to show player health bar. It is rather complicated to accomplish, event with detailed instructions and assets available out of the box. In the end, I might not even need, as Hungry Square ends as soon as the player is hit by an enemy.</p>\n<p>Next part is about creating non-playable characters and interacting with them. It also shows how to create dialog and quests. As none of these features are planned for Hungry Square, I decided to skip this tutorial altogether. Might come back to it eventually, for completeness sake.</p>\n<h2 id=\"Day-10\"><a href=\"#Day-10\" class=\"headerlink\" title=\"Day 10\"></a>Day 10</h2><p>Last few tutorials dealt with quite important concepts. First one taught me how to add audio listeners, and how to produce 2D and 3D sounds. If I find suitable audio clips, I might add them to objects in my game.</p>\n<p>Finally, I learned how to build the whole project into an executable. Realized that I had wrong platform selected the entire time, so I switched to WebGL. Analyzed and tried to learn about all available options, as WebGL will be my primary platform.</p>\n<h2 id=\"Day-11\"><a href=\"#Day-11\" class=\"headerlink\" title=\"Day 11\"></a>Day 11</h2><p>With all tutorials completed, it is time to finally start working on Hungry Square remaster! With all important Unity concepts still fresh in my head, I manage to get a lot of work done on first sitting. Immediately found some free sprite assets in the shape of a square, and used them to create prefabs for player, enemies and food. Instead of handling enemy movement on my own, like in the original game, I try to utilize Unity physics system. All I had to was create an edge collider around game area, assign absolutely elastic material to it, and do the same for each enemy. On enemy spawn, an impulse force was applied to its rigid body, and physics system took care of the rest. Easy peasy!</p>\n<p>To detect player collisions, I have added colliders to player, enemies and food, and assigned proper tags to each. Had to prevent enemies from crashing into food, so moved each one to dedicated collision layer, and turned off interactions between them.</p>\n<p><em>Issue detected: enemies are configured to speed up after each edge bounce, before I introduce concept of game speed. Noticed that after some time, enemies get so fast, that they skip screen edge collider, and simply disappear out of the game. Funny thing to occur, sine the original game had the exact same problem, due to enemy position after bounce being miscalculated sometimes. Something I must not forget to fix later.</em></p>\n<h2 id=\"Day-12\"><a href=\"#Day-12\" class=\"headerlink\" title=\"Day 12\"></a>Day 12</h2><p>This time I focused on adding game logic. Handled player collision with enemy, screen edge and food. Soon I will have to introduce concept of scoring, as well as create game over screen to show in the end.</p>\n<p>After eating food, game spawns another enemy and food at random location. It works, but I am not happy with implementation. Player and game objects reference all prefabs, in order to dynamically create them or invoke their methods. Will try to look for a better solution, and reduce coupling between objects.</p>\n<p>Spent some time investigating disappearing enemy issue. It seems that this is a known limitation of Unity’s physics engine, which checks collisions only at fixed points in time. Fixing such behavior can only be achieved by limiting maximum object speed. Enemies should not be allowed to go through screen edge in one fixed update, so I will set maximum speed to enemy length divided by period of fixed update. Seemed to help, as I don’t detect any enemies dropping out of the game area anymore.</p>\n<h2 id=\"Day-13\"><a href=\"#Day-13\" class=\"headerlink\" title=\"Day 13\"></a>Day 13</h2><p>Found a way to implement prefab registry, using dedicated singleton object. Reworked all types to use prefab registry, instead of assigning them as properties. I am sure there is an even better way to reference prefabs from game objects, but hey, I am not a professional Unity developer <span class=\"github-emoji\" alias=\"smile\" style=\"\" fallback-src=\"https://github.githubassets.com/images/icons/emoji/unicode/1f604.png?v8\">😄</span></p>\n<h2 id=\"Day-14\"><a href=\"#Day-14\" class=\"headerlink\" title=\"Day 14\"></a>Day 14</h2><p>Today I mostly dealt with endgame features. Went through a tutorial on how to implement game over screen, and added it to Hungry Square. It will be shown on collision with either enemy or screen edge. After finishing the game, it is possible to restart it via menu button. </p>\n<p><em>Issue detected: After restarting game, I noticed that keyboard input is not detected anymore, even though player and initial food objects are spawned correctly. Might be just a minor hiccup because of whole scene reload, but surely something I need to address soon.</em></p>\n<h2 id=\"Day-15\"><a href=\"#Day-15\" class=\"headerlink\" title=\"Day 15\"></a>Day 15</h2><p>Used Game Controller to centralize game speed, instead of spreading it through various scripts. Player and enemy movement will be adjusted based on this value, which is increasing by couple of percent each time a player consumes food. Works well, and I remove enemy speedup on screen edge bounce.</p>\n<p>Input is still not working after game restart, event though I tried couple of fixes. Will have to check if it happens in built game as well, but I am starting to get worried.</p>\n<h2 id=\"Day-16\"><a href=\"#Day-16\" class=\"headerlink\" title=\"Day 16\"></a>Day 16</h2><p>Since I wanted to test built version anyways, I dedicated all available time today to get CI/CD pipeline up and running. Had a lot of fun discovering how Unity games are built and tested, and how to deploy build output. So much fun actually, that I documented the whole process <a href=\"../github-workflow-unity-azure-static-webapps\">in a companion article</a>.</p>\n<h2 id=\"Day-17\"><a href=\"#Day-17\" class=\"headerlink\" title=\"Day 17\"></a>Day 17</h2><p>Finally managed to solve non-responsive inputs after game is restarted. Turns out inputs were working fine the whole time, but the game remained paused after scene reload. Adjusted time scale after scene reload, and the game runs as expected. Crisis averted!</p>\n<p>Continuing to work on improving overall player experience. Food and enemies were spawning randomly, which sometimes caused immediate collision with player. Adjusted this behavior to a more predictable pattern, and made them spawn randomly on the opposite space of playable area. Also started tracking score and using game over screen to show it to the player.</p>\n<h2 id=\"Day-18\"><a href=\"#Day-18\" class=\"headerlink\" title=\"Day 18\"></a>Day 18</h2><p>Encountered an issue on game over screen, happening for built game only. An exception was being thrown, but it was impossible to find out what part of code was causing it. Had to learn how to produce a debug build and expose exception call stack. Turns out an instance of a text field was not properly assigned to game over screen, which caused a NullReferenceException. However, this issue does not arise in play mode. Strange… Solved it by reassigning text field instance to game over object.</p>\n<h2 id=\"Day-19\"><a href=\"#Day-19\" class=\"headerlink\" title=\"Day 19\"></a>Day 19</h2><p>Worked on quality of life improvements. Player, food and enemy collision areas were too big, so I decided to reduce them to fit actual shape of each object. By increasing main sprite pixels per unit a bit, made all relevant objects smaller, and made the game area look a bit bigger. I guess I could have achieved similar behavior by moving the camera a bit further from the player.</p>\n<h2 id=\"Day-20\"><a href=\"#Day-20\" class=\"headerlink\" title=\"Day 20\"></a>Day 20</h2><p>Added main menu and included a small game description. Initially I wanted to implement it in the same way as game over screen, but soon realized that it is better to extract it to a separate scene. Main menu scene will be shown first and, once start button is pressed, game scene will be loaded.</p>\n<h2 id=\"Day-21\"><a href=\"#Day-21\" class=\"headerlink\" title=\"Day 21\"></a>Day 21</h2><p>Putting in last few tweaks and doing a final round of testing. Everything seems to be in order, and Hungry Square remastered is ready to be shipped!</p>\n<h2 id=\"Final-thoughts\"><a href=\"#Final-thoughts\" class=\"headerlink\" title=\"Final thoughts\"></a>Final thoughts</h2><p>It has been quite a ride. My initial assumption, that I would rework the game in couple of days, turned into endeavor that lasted almost the whole month. Nevertheless, I am quite happy with the end product, especially because I managed to combine it with other thing I love - Azure!</p>\n<p>On the other hand, I am not so satisfied that remaster is still pretty bare-bones. Visually nothing much changed from a 20 year old game, and the lack of animations and sounds makes the game look very rudimentary. Surely something I will seek to correct in the future. But for now, I think I have a pretty good base to build upon.</p>\n<h2 id=\"Conclusion\"><a href=\"#Conclusion\" class=\"headerlink\" title=\"Conclusion\"></a>Conclusion</h2><p>If you ever think about going the same path as me, I hope this post would help you avoid making mistakes that I did. Although Unity is complex, learning about it’s various concepts can be quite fun. It is used to make games, after all.</p>\n<p>Coming back to Hungry Square, the game is up and running in an Azure Static Web Apps instance, and it will remain deployed there for the time being. You can see the final result, and try it out <a href=\"https://red-plant-049cdf903.2.azurestaticapps.net/\">via an URL that was randomly assigned by Azure Static Web Apps</a> (sorry for any anti-virus alerts I caused). My high score is 24, can you try to beat it? Let me know!</p>\n</body></html>",
            "tags": [
                "dotnet",
                "unity",
                "begginer"
            ]
        },
        {
            "id": "https://www.uveta.io/categories/blog/unclutter-startup-cs/",
            "url": "https://www.uveta.io/categories/blog/unclutter-startup-cs/",
            "title": "Unclutter Startup.cs",
            "date_published": "2021-12-18T14:00:09.000Z",
            "content_html": "<html><head></head><body><img src=\"/categories/blog/unclutter-startup-cs/calendar.jpg\" class=\"\" title=\"Advent calendar\">\n\n<p>Configuring service container and setting up request pipeline in ASP.NET Core can eat up a lot of lines of code, especially for more complex projects. A well-established way of doing this is using <em>Startup.cs</em> and its <code>ConfigureServices()</code> and <code>Configure()</code> methods. Although complete application setup can be packed into a single type, we must not forget about Single-responsibility principle. I wanted to show you a way to prevent startup from growing uncontrollably, by keeping different concerns separate from each other.</p>\n<p>One disclaimer though. ASP.NET Core 6 has rolled in and removed the need of having <em>Startup.cs</em> altogether. Despite that fact, I am sure the ideas presented in this post will be relevant, even in the new era.</p>\n<span id=\"more\"></span>\n\n<p><em>This post is part of <a href=\"https://www.csadvent.christmas/\">C# Advent Calendar 2021</a>. Cheers to <a href=\"https://twitter.com/mgroves\">Matthew D. Groves</a> for letting me participate!</em></p>\n<h2 id=\"Basic-principles\"><a href=\"#Basic-principles\" class=\"headerlink\" title=\"Basic principles\"></a>Basic principles</h2><p>We will apply two .NET features: <a href=\"https://docs.microsoft.com/en-us/aspnet/core/fundamentals/configuration/options\">Options pattern</a> and <a href=\"https://docs.microsoft.com/en-us/dotnet/csharp/programming-guide/classes-and-structs/extension-methods\">Extension methods</a>. Similar to how ASP.NET Core uses plugin architecture, we will utilize these features to separate concerns and leave heavy lifting to dependency injection container.</p>\n<p>One design standard, to keep in mind, is that almost all parts of ASP.NET Core are configured via <a href=\"https://docs.microsoft.com/en-us/dotnet/api/microsoft.extensions.options.ioptions-1\">IOptions<toptions></toptions></a> pattern. And, since all <code>IOptions&lt;TOptions&gt;</code> instances are part of service container, we can use <a href=\"https://docs.microsoft.com/en-us/aspnet/core/fundamentals/configuration/options#use-di-services-to-configure-options\">IConfigureOptions<toptions></toptions></a> or <a href=\"https://docs.microsoft.com/en-us/aspnet/core/fundamentals/configuration/options#options-post-configuration\">IPostConfigureOptions<toptions></toptions></a> to override any one of them.</p>\n<h2 id=\"MVC\"><a href=\"#MVC\" class=\"headerlink\" title=\"MVC\"></a>MVC</h2><p>Whether you are using Controllers only, or including Views or Razor Pages, MVC setup is more or less the same. The goal is to call <a href=\"https://docs.microsoft.com/en-us/dotnet/api/microsoft.extensions.dependencyinjection.mvcservicecollectionextensions.addcontrollers\">AddControllers()</a>, <a href=\"https://docs.microsoft.com/en-us/dotnet/api/microsoft.extensions.dependencyinjection.mvcservicecollectionextensions.addcontrollerswithviews\">AddControllersWithViews()</a> or <a href=\"https://docs.microsoft.com/en-us/dotnet/api/microsoft.extensions.dependencyinjection.mvcservicecollectionextensions.addrazorpages\">AddRazorPages()</a>, based on your scenario, and define configuration for <a href=\"https://docs.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.mvcoptions\">MvcOptions</a>, and possibly <a href=\"https://docs.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.razorpages.razorpagesoptions\">RazorPagesOptions</a>. If you are using <a href=\"https://docs.microsoft.com/en-us/dotnet/api/system.text.json.jsonserializer\">System.Text.Json</a> or <a href=\"https://www.nuget.org/packages/Microsoft.AspNetCore.Mvc.NewtonsoftJson\">Newtonsoft Json.NET</a> for model serialization, you could also configure them in a similar manner. Whole setup would look like this:</p>\n<figure class=\"highlight csharp hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">static</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">MvcExtensions</span></span><br><span class=\"line\">{</span><br><span class=\"line\">    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">static</span> IServiceCollection <span class=\"hljs-title\">ConfigureMvc</span>(<span class=\"hljs-params\"><span class=\"hljs-keyword\">this</span> IServiceCollection services</span>)</span></span><br><span class=\"line\">    {</span><br><span class=\"line\">        services.AddControllers().AddNewtonsoftJson();</span><br><span class=\"line\">        services.AddSingleton&lt;IConfigureOptions&lt;MvcOptions&gt;, ConfigureMvcOptions&gt;();</span><br><span class=\"line\">        services.AddSingleton&lt;IConfigureOptions&lt;MvcNewtonsoftJsonOptions&gt;, ConfigureNewtonsoftOptions&gt;();</span><br><span class=\"line\">        <span class=\"hljs-keyword\">return</span> services;</span><br><span class=\"line\">    }</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">ConfigureMvcOptions</span> : <span class=\"hljs-title\">IConfigureOptions</span>&lt;<span class=\"hljs-title\">MvcOptions</span>&gt;</span><br><span class=\"line\">{</span><br><span class=\"line\">    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">Configure</span>(<span class=\"hljs-params\">MvcOptions options</span>)</span></span><br><span class=\"line\">    {</span><br><span class=\"line\">        options.SuppressAsyncSuffixInActionNames = <span class=\"hljs-literal\">true</span>;</span><br><span class=\"line\">    }</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">ConfigureNewtonsoftOptions</span> : <span class=\"hljs-title\">IConfigureOptions</span>&lt;<span class=\"hljs-title\">MvcNewtonsoftJsonOptions</span>&gt;</span><br><span class=\"line\">{</span><br><span class=\"line\">    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">Configure</span>(<span class=\"hljs-params\">MvcNewtonsoftJsonOptions options</span>)</span></span><br><span class=\"line\">    {</span><br><span class=\"line\">        options.SerializerSettings.Converters.Add(<span class=\"hljs-keyword\">new</span> StringEnumConverter());</span><br><span class=\"line\">    }</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<h2 id=\"Authentication\"><a href=\"#Authentication\" class=\"headerlink\" title=\"Authentication\"></a>Authentication</h2><p>Completely driving authentication by configuration is difficult. You probably need to know what type of authentication your application uses in advance. Good news is that, once baseline is established, you can use above mentioned technique to configure individual parts. For example, you would use <a href=\"https://docs.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.authentication.cookies.cookieauthenticationoptions\">CookieAuthenticationOptions</a> to configure cookies, and <a href=\"https://docs.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.authentication.jwtbearer.jwtbeareroptions\">JwtBearerOptions</a> for token based authentication. Extension and individual configuration options, including an example of injecting IConfiguration into one of them, would look like this:</p>\n<figure class=\"highlight csharp hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">static</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">AuthenticationExtensions</span></span><br><span class=\"line\">{</span><br><span class=\"line\">    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">static</span> IServiceCollection <span class=\"hljs-title\">ConfigureAuthentication</span>(<span class=\"hljs-params\"><span class=\"hljs-keyword\">this</span> IServiceCollection services</span>)</span></span><br><span class=\"line\">    {</span><br><span class=\"line\">        services.AddAuthentication().AddCookie().AddJwtBearer();</span><br><span class=\"line\">        services.AddSingleton&lt;IConfigureOptions&lt;AuthenticationOptions&gt;, ConfigureAuthenticationOptions&gt;();</span><br><span class=\"line\">        services.AddSingleton&lt;IConfigureOptions&lt;CookieAuthenticationOptions&gt;, ConfigureCookieAuthenticationOptions&gt;();</span><br><span class=\"line\">        services.AddSingleton&lt;IConfigureOptions&lt;JwtBearerOptions&gt;, ConfigureJwtBearerOptions&gt;();</span><br><span class=\"line\">        <span class=\"hljs-keyword\">return</span> services;</span><br><span class=\"line\">    }</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">ConfigureAuthenticationOptions</span> : <span class=\"hljs-title\">IConfigureOptions</span>&lt;<span class=\"hljs-title\">AuthenticationOptions</span>&gt;</span><br><span class=\"line\">{</span><br><span class=\"line\">    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">Configure</span>(<span class=\"hljs-params\">AuthenticationOptions options</span>)</span></span><br><span class=\"line\">    {</span><br><span class=\"line\">        options.DefaultAuthenticateScheme = JwtBearerDefaults.AuthenticationScheme;</span><br><span class=\"line\">        options.DefaultChallengeScheme = JwtBearerDefaults.AuthenticationScheme;</span><br><span class=\"line\">    }</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">ConfigureCookieAuthenticationOptions</span> : <span class=\"hljs-title\">IConfigureOptions</span>&lt;<span class=\"hljs-title\">CookieAuthenticationOptions</span>&gt;</span><br><span class=\"line\">{</span><br><span class=\"line\">    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">Configure</span>(<span class=\"hljs-params\">CookieAuthenticationOptions options</span>)</span></span><br><span class=\"line\">    {</span><br><span class=\"line\">        options.ExpireTimeSpan = TimeSpan.FromHours(<span class=\"hljs-number\">1</span>);</span><br><span class=\"line\">    }</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">ConfigureJwtBearerOptions</span> : <span class=\"hljs-title\">IConfigureOptions</span>&lt;<span class=\"hljs-title\">JwtBearerOptions</span>&gt;</span><br><span class=\"line\">{</span><br><span class=\"line\">    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">readonly</span> IConfiguration _configuration;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-title\">ConfigureJwtBearerOptions</span>(<span class=\"hljs-params\">IConfiguration configuration</span>)</span></span><br><span class=\"line\">    {</span><br><span class=\"line\">        _configuration = configuration;</span><br><span class=\"line\">    }</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">Configure</span>(<span class=\"hljs-params\">JwtBearerOptions options</span>)</span></span><br><span class=\"line\">    {</span><br><span class=\"line\">        options.Authority = _configuration.GetValue&lt;<span class=\"hljs-built_in\">string</span>&gt;(<span class=\"hljs-string\">\"jwt:authority\"</span>);</span><br><span class=\"line\">        options.RequireHttpsMetadata = <span class=\"hljs-literal\">false</span>;</span><br><span class=\"line\">        options.IncludeErrorDetails = <span class=\"hljs-literal\">true</span>;</span><br><span class=\"line\">    }</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<h2 id=\"Authorization\"><a href=\"#Authorization\" class=\"headerlink\" title=\"Authorization\"></a>Authorization</h2><p>Configuring authorization can get quite tedious, if number or complexity of policies increases. Luckily, setup process is pretty straightforward, as the only concern is injecting configuration via <a href=\"https://docs.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.authorization.authorizationoptions\">AuthorizationOptions</a> type.</p>\n<figure class=\"highlight csharp hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">static</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">AuthorizationExtensions</span></span><br><span class=\"line\">{</span><br><span class=\"line\">    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">static</span> IServiceCollection <span class=\"hljs-title\">ConfigureAuthorization</span>(<span class=\"hljs-params\"><span class=\"hljs-keyword\">this</span> IServiceCollection services</span>)</span></span><br><span class=\"line\">    {</span><br><span class=\"line\">        services.AddAuthorization();</span><br><span class=\"line\">        services.AddSingleton&lt;IConfigureOptions&lt;AuthorizationOptions&gt;, ConfigureAuthorizationOptions&gt;();</span><br><span class=\"line\">        <span class=\"hljs-keyword\">return</span> services;</span><br><span class=\"line\">    }</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">ConfigureAuthorizationOptions</span> : <span class=\"hljs-title\">IConfigureOptions</span>&lt;<span class=\"hljs-title\">AuthorizationOptions</span>&gt;</span><br><span class=\"line\">{</span><br><span class=\"line\">    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">Configure</span>(<span class=\"hljs-params\">AuthorizationOptions options</span>)</span></span><br><span class=\"line\">    {</span><br><span class=\"line\">        options.DefaultPolicy = <span class=\"hljs-keyword\">new</span> AuthorizationPolicyBuilder().RequireAuthenticatedUser().Build();</span><br><span class=\"line\">    }</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<h2 id=\"OpenAPI\"><a href=\"#OpenAPI\" class=\"headerlink\" title=\"OpenAPI\"></a>OpenAPI</h2><p>If you care about your REST API consumers, you are publishing service description, using OpenAPI specification. And, since we are talking about ASP.NET Core, you are probably using awesome <a href=\"https://www.nuget.org/packages/Swashbuckle.AspNetCore\">Swashbuckle</a> package. As with previously mentioned framework parts, this extension was designed on same principles, and can be setup in a similar fashion. Whether its generating definition file using <code>SwaggerGenOptions</code>, or adjusting swagger user interface via <code>SwaggerUIOptions</code>, everything can be broken down and put into separate types.</p>\n<figure class=\"highlight csharp hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">static</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">OpenApiExtensions</span></span><br><span class=\"line\">{</span><br><span class=\"line\">    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">static</span> IServiceCollection <span class=\"hljs-title\">ConfigureOpenApi</span>(<span class=\"hljs-params\"><span class=\"hljs-keyword\">this</span> IServiceCollection services</span>)</span></span><br><span class=\"line\">    {</span><br><span class=\"line\">        services.AddSwaggerGen();</span><br><span class=\"line\">        services.AddSwaggerGenNewtonsoftSupport();</span><br><span class=\"line\">        services.AddSingleton&lt;IConfigureOptions&lt;SwaggerGenOptions&gt;, ConfigureSwaggerGenOptions&gt;();</span><br><span class=\"line\">        services.AddSingleton&lt;IConfigureOptions&lt;SwaggerOptions&gt;, ConfigureSwaggerOptions&gt;();</span><br><span class=\"line\">        services.AddSingleton&lt;IConfigureOptions&lt;SwaggerUIOptions&gt;, ConfigureSwaggerUiOptions&gt;();</span><br><span class=\"line\">        <span class=\"hljs-keyword\">return</span> services;</span><br><span class=\"line\">    }</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">ConfigureSwaggerGenOptions</span> : <span class=\"hljs-title\">IConfigureOptions</span>&lt;<span class=\"hljs-title\">SwaggerGenOptions</span>&gt;</span><br><span class=\"line\">{</span><br><span class=\"line\">    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">Configure</span>(<span class=\"hljs-params\">SwaggerGenOptions options</span>)</span></span><br><span class=\"line\">    {</span><br><span class=\"line\">        options.SwaggerDoc(<span class=\"hljs-string\">\"v1\"</span>, <span class=\"hljs-keyword\">new</span> OpenApiInfo { Title = <span class=\"hljs-string\">\"Demo\"</span>, Version = <span class=\"hljs-string\">\"v1\"</span> });</span><br><span class=\"line\">    }</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">ConfigureSwaggerOptions</span> : <span class=\"hljs-title\">IConfigureOptions</span>&lt;<span class=\"hljs-title\">SwaggerOptions</span>&gt;</span><br><span class=\"line\">{</span><br><span class=\"line\">    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">Configure</span>(<span class=\"hljs-params\">SwaggerOptions options</span>)</span></span><br><span class=\"line\">    {</span><br><span class=\"line\">        options.RouteTemplate = <span class=\"hljs-string\">\"swagger/{documentName}/swagger.json\"</span>;</span><br><span class=\"line\">        options.PreSerializeFilters.Add((swaggerDoc, httpReq) =&gt;</span><br><span class=\"line\">        {</span><br><span class=\"line\">            swaggerDoc.Servers = <span class=\"hljs-keyword\">new</span>[] {</span><br><span class=\"line\">                <span class=\"hljs-keyword\">new</span> OpenApiServer {</span><br><span class=\"line\">                    Url = <span class=\"hljs-string\">$\"<span class=\"hljs-subst\">{httpReq.Scheme}</span>://<span class=\"hljs-subst\">{httpReq.Host.Value}</span><span class=\"hljs-subst\">{httpReq.PathBase}</span>\"</span>,</span><br><span class=\"line\">                    Description = <span class=\"hljs-string\">\"Default\"</span></span><br><span class=\"line\">                }</span><br><span class=\"line\">            };</span><br><span class=\"line\">        });</span><br><span class=\"line\">    }</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">ConfigureSwaggerUiOptions</span> : <span class=\"hljs-title\">IConfigureOptions</span>&lt;<span class=\"hljs-title\">SwaggerUIOptions</span>&gt;</span><br><span class=\"line\">{</span><br><span class=\"line\">    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">Configure</span>(<span class=\"hljs-params\">SwaggerUIOptions options</span>)</span></span><br><span class=\"line\">    {</span><br><span class=\"line\">        options.SwaggerEndpoint(<span class=\"hljs-string\">\"/swagger/v1/swagger.json\"</span>, <span class=\"hljs-string\">\"Demo v1\"</span>);</span><br><span class=\"line\">    }</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<h2 id=\"Application-Insights\"><a href=\"#Application-Insights\" class=\"headerlink\" title=\"Application Insights\"></a>Application Insights</h2><p>How about some Azure extensions? Most of the time you will not even need them, as ASP.NET Core seamlessly integrates with most of Azure resources. However, one particular extension I recommend using are <a href=\"https://www.nuget.org/packages/Microsoft.ApplicationInsights.AspNetCore\">Application Insights</a>. You want to have application telemetry under control, and this package allows you to fine tune metrics and data that will be ingested by Azure. From setup point of view, there is nothing surprising:</p>\n<figure class=\"highlight csharp hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">static</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">TelemetryExtensions</span></span><br><span class=\"line\">{</span><br><span class=\"line\">    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">static</span> IServiceCollection <span class=\"hljs-title\">ConfigureTelemetry</span>(<span class=\"hljs-params\"><span class=\"hljs-keyword\">this</span> IServiceCollection services</span>)</span></span><br><span class=\"line\">    {</span><br><span class=\"line\">        services.AddApplicationInsightsTelemetry();</span><br><span class=\"line\">        services.AddSingleton&lt;IConfigureOptions&lt;ApplicationInsightsServiceOptions&gt;, ConfigureApplicationInsights&gt;();</span><br><span class=\"line\">        <span class=\"hljs-keyword\">return</span> services;</span><br><span class=\"line\">    }</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">ConfigureApplicationInsights</span> : <span class=\"hljs-title\">IConfigureOptions</span>&lt;<span class=\"hljs-title\">ApplicationInsightsServiceOptions</span>&gt;</span><br><span class=\"line\">{</span><br><span class=\"line\">    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">Configure</span>(<span class=\"hljs-params\">ApplicationInsightsServiceOptions options</span>)</span></span><br><span class=\"line\">    {</span><br><span class=\"line\">        options.EnableHeartbeat = <span class=\"hljs-literal\">true</span>;</span><br><span class=\"line\">        options.EnableAppServicesHeartbeatTelemetryModule = <span class=\"hljs-literal\">true</span>;</span><br><span class=\"line\">    }</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<h2 id=\"Extras\"><a href=\"#Extras\" class=\"headerlink\" title=\"Extras\"></a>Extras</h2><p>You’ve probably gotten the gist of it by now; use extension methods to extract service definitions, and options to do actual service configuration. For completeness, let me give you the rest of commonly used ASP.NET Core features, including types used for configuration.</p>\n<ul>\n<li>Default files middleware via <a href=\"https://docs.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.defaultfilesextensions.usedefaultfiles\">UseDefaultFiles()</a> - <a href=\"https://docs.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.defaultfilesoptions\">DefaultFilesOptions</a></li>\n<li>Static files middleware via <a href=\"https://docs.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.staticfileextensions.usestaticfiles\">UseStaticFiles()</a> - <a href=\"https://docs.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.staticfileoptions\">StaticFileOptions</a></li>\n<li>Cross-Origin Resource Sharing via <a href=\"https://docs.microsoft.com/en-us/dotnet/api/microsoft.extensions.dependencyinjection.corsservicecollectionextensions.addcors\">AddCors()</a> - <a href=\"https://docs.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.cors.infrastructure.corsoptions?view=aspnetcore-6.0\">CorsOptions</a></li>\n<li>API Versioning services via <a href=\"https://www.nuget.org/packages/Microsoft.AspNetCore.Mvc.Versioning\">AddApiVersioning() and AddVersionedApiExplorer()</a> - <a href=\"https://github.com/dotnet/aspnet-api-versioning/blob/master/src/Microsoft.AspNetCore.Mvc.Versioning.ApiExplorer/ApiExplorerOptions.cs\">ApiExplorerOptions</a> and <a href=\"https://github.com/dotnet/aspnet-api-versioning/blob/master/src/Common/Versioning/ApiVersioningOptions.cs\">ApiVersioningOptions</a></li>\n</ul>\n<h2 id=\"Application-code\"><a href=\"#Application-code\" class=\"headerlink\" title=\"Application code\"></a>Application code</h2><p>Last but not least, what about your own application code? I highly recommend following the same principles, in order to avoid having application setup in a single place. If you are using clean architecture, and have your code decoupled into layers, initialization could be as simple as:</p>\n<figure class=\"highlight csharp hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">static</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">ApplicationExtensions</span></span><br><span class=\"line\">{</span><br><span class=\"line\">    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">static</span> IServiceCollection <span class=\"hljs-title\">ConfigureApplication</span>(<span class=\"hljs-params\"><span class=\"hljs-keyword\">this</span> IServiceCollection services</span>)</span></span><br><span class=\"line\">    {</span><br><span class=\"line\">        services</span><br><span class=\"line\">            .AddDomain()</span><br><span class=\"line\">            .AddApplicationServices()</span><br><span class=\"line\">            .AddRepositories()</span><br><span class=\"line\">            .AddIntegration();</span><br><span class=\"line\">        <span class=\"hljs-keyword\">return</span> services;</span><br><span class=\"line\">    }</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<h2 id=\"Conclusion\"><a href=\"#Conclusion\" class=\"headerlink\" title=\"Conclusion\"></a>Conclusion</h2><p>I have shown you one neat little trick that I use all the time, when setting up any kind of application. It is important to remember Single-responsibility principle, even for this type of code. Having <em>Startup.cs</em> consisting of several hundreds, or even thousands lines, is nothing unheard of. And, sadly, is an obvious code smell.</p>\n<p>All code shown in this post was published to <a href=\"https://github.com/uveta/demo-unclutter-startup\">GitHub</a>, as a single ASP.NET Core 6 project.</p>\n</body></html>",
            "tags": [
                "azure",
                "advanced",
                "dotnet"
            ]
        },
        {
            "id": "https://www.uveta.io/categories/blog/asynchronous-job-pattern-the-asp-net-core-mvc-way/",
            "url": "https://www.uveta.io/categories/blog/asynchronous-job-pattern-the-asp-net-core-mvc-way/",
            "title": "Asynchronous Job Pattern - The ASP.NET Core MVC Way",
            "date_published": "2020-12-21T20:33:44.000Z",
            "content_html": "<html><head></head><body><img src=\"/categories/blog/asynchronous-job-pattern-the-asp-net-core-mvc-way/calendar.jpg\" class=\"\" title=\"Advent calendar\">\n\n<p>Let me present a pattern we used to solve a problem haunting our enterprise application for ages. It was initially designed to handle long running operations, using <a href=\"http://restalk-patterns.org/long-running-operation-polling.html\">RESTful approach</a>, but we soon realized it could be used in many other ways. As it generalizes the system of submitting requests and obtaining responses, it can easily be adapted to different business processes, while keeping unified client interface.</p>\n<span id=\"more\"></span>\n\n<p><em>This post is part of <a href=\"https://www.csadvent.christmas/\">C# Advent Calendar 2020</a>. Cheers to <a href=\"https://twitter.com/mgroves\">Matthew D. Groves</a> for letting me participate!</em></p>\n<h2 id=\"Building-blocks\"><a href=\"#Building-blocks\" class=\"headerlink\" title=\"Building blocks\"></a>Building blocks</h2><p>From a <em>client</em> perspective, the pattern usage is pretty simple: it submits a <em>job</em> for processing to an <em>endpoint</em>; <em>job</em> status is polled until processing is finished; if status was successful, client uses <em>endpoint</em> to obtain output.</p>\n<p>On server side, several components are required to achieve such functionality. Lets take a look at the big picture and define individual pattern pieces.</p>\n<h3 id=\"Job\"><a href=\"#Job\" class=\"headerlink\" title=\"Job\"></a>Job</h3><p>A <em>job</em> is a principal entity, representing <em>client</em> intent processed by a designated <em>worker</em>. It is composed of:</p>\n<ul>\n<li><strong>Header</strong>, containing job metadata such as unique identifier, current status, time of creation/start/finish, potential issues as well as estimated time of completion</li>\n<li><strong>Input parameters</strong></li>\n<li><strong>Output values</strong></li>\n</ul>\n<h3 id=\"Worker\"><a href=\"#Worker\" class=\"headerlink\" title=\"Worker\"></a>Worker</h3><p>Component that does heavy lifting. Main responsibility is actual processing, as each <em>worker</em> is able to handle specific <em>job</em> type. In simple terms, we can describe it as a function accepting input parameters and returning either <em>job</em> output or an error.</p>\n<h3 id=\"Endpoint\"><a href=\"#Endpoint\" class=\"headerlink\" title=\"Endpoint\"></a>Endpoint</h3><p>Serves as an entry-point for <em>clients</em>. After creating a job, <em>client</em> should be able to obtain <em>job</em> status at any point in time, as well as output after processing is finished. <em>Endpoint</em> should also allow <em>client</em> to cancel and clean-up a <em>job</em>. Hence, it needs to provide following services:</p>\n<ul>\n<li>Create <em>job</em></li>\n<li>Get <em>job</em> status</li>\n<li>Get <em>job</em> output</li>\n<li>Delete <em>job</em></li>\n</ul>\n<h3 id=\"Job-Repository-and-Queue\"><a href=\"#Job-Repository-and-Queue\" class=\"headerlink\" title=\"Job Repository and Queue\"></a>Job Repository and Queue</h3><p>A <em>repository</em> will be used to store all <em>jobs</em>, which would allow both <em>endpoint</em> and <em>worker</em> to read and update <em>job</em> state. For now, let’s consider <em>repository</em> an abstraction, as concrete implementation and storage technology may vary, depending on usage scenario.</p>\n<p>Binding between an <em>endpoint</em> and a <em>worker</em> would be achieved using a <em>job queue</em> concept. It has to provide a <em>producer</em> and a <em>consumer</em>, depending on the component using <em>queue</em> services. Similar to how <em>repository</em> was defined, implementation may range from memory one to a hyper-scale message broker. </p>\n<p>Final pattern architecture is depicted in the diagram bellow. As all core components are defined, we should move on to implementation using APS.NET Core.</p>\n<p><img src=\"architecture.png\" alt=\"Job pattern architecture\"></p>\n<h2 id=\"ASP-NET-Core-implementation\"><a href=\"#ASP-NET-Core-implementation\" class=\"headerlink\" title=\"ASP.NET Core implementation\"></a>ASP.NET Core implementation</h2><h3 id=\"Implementation-considerations\"><a href=\"#Implementation-considerations\" class=\"headerlink\" title=\"Implementation considerations\"></a>Implementation considerations</h3><p>In order to make the implementation as universal as possible, we need to limit <em>job</em> inputs and outputs to one of each. If multiple values are expected, they could be provided via a custom model. <code>JobExecutionResult</code> will serve as a wrapper for output value, containing result of <em>worker</em> execution and any possible issues. If we define them as types <code>TInput</code> and <code>TOutput</code>, our <em>worker</em> and <em>endpoint</em> could look something like this:</p>\n<script src=\"https://gist.github.com/uveta/85943b7354871239058c4b45ffca8ee9.js\"></script>\n<script src=\"https://gist.github.com/uveta/9ebe4d6514c8bf6d22dca908eeeb0c04.js\"></script>\n\n<p>As <em>endpoint</em> is user independent concept, it will be up to pattern to provide the implementation. On the other hand, <em>worker</em> is responsible for executing custom actions, hence it’s implementation has to be provided by the pattern user. This reasoning will come into play during design, as we would like to provide plugin architecture for individual pattern components. This will allow utilizing only building blocks required for given scenario, while the user would provide implementation of required and customizable parts.</p>\n<h3 id=\"Plugging-in-worker-implementation\"><a href=\"#Plugging-in-worker-implementation\" class=\"headerlink\" title=\"Plugging in worker implementation\"></a>Plugging in worker implementation</h3><p><em>Worker</em> flow is straightforward: it should use <em>queue consumer</em> to listen for incoming <em>jobs</em>; whenever one is received, it should process it and update <em>job</em> status and output via <em>repository</em>; then it waits for next one and repeats previous steps. This cycle is supposed to run for the whole application lifetime, as new <em>jobs</em> can arrive at any time. A natural solution to implement such functionality are <a href=\"https://docs.microsoft.com/en-us/aspnet/core/fundamentals/host/hosted-services\">hosted services</a>. In our case, we could extract all common code (starting <em>queue consumer</em>, input/output serialization and <em>job</em> update) to a <code>WorkerInvoker&lt;TWorker&gt;</code> hosted service, bound to specific <em>worker</em> by it generic type <code>TWorker</code>.</p>\n<p>Adding <code>TWorker</code> type to DI container has multiple benefits. On one side, it can be injected into <code>WorkerInvoker&lt;TWorker&gt;</code>, removing the need to create it manually. On the other hand, it allows developers of <code>TWorker</code> to freely inject business services into it.</p>\n<h3 id=\"Exposing-endpoints\"><a href=\"#Exposing-endpoints\" class=\"headerlink\" title=\"Exposing endpoints\"></a>Exposing endpoints</h3><p>Since controllers are used as primary entry point into MVC applications, they are an obvious choice for coupling with <em>endpoints</em>. In this case, <a href=\"http://restalk-patterns.org/long-running-operation-polling.html\">initial description</a> should be followed to the letter, as we are in domain of HTTP REST operations. Hence, controllers should include following routes:</p>\n<ul>\n<li><strong>POST <em>/jobs</em></strong>: allows creating new jobs; responds with status <em>202 (Accepted)</em>, containing <em>job</em> resource <em>URL</em></li>\n<li><strong>GET <em>/jobs/{jobId}</em></strong>: resource <em>URL</em> can be used for polling <em>job</em> status, while in progress; when processing is finished, use <em>303 (See Other)</em> redirect to provide client with an output resource <em>URL</em></li>\n<li><strong>GET <em>/jobs/{jobId}/output</em></strong>: output resource <em>URL</em>; should return <em>200 (OK)</em> result containing output value, after <em>job</em> processing finishes; returns <em>404 (NotFound)</em> error otherwise</li>\n<li><strong>DELETE <em>/jobs/{jobId}</em></strong>: disposes of any reserved resources; client should call it after polling finishes and output is obtained; if not done by client, server should clean up old <em>jobs</em> automatically</li>\n</ul>\n<p>The burden of creating a controller should not fall on the user; it is the responsibility of the pattern itself, since each route functionality is known in advance. For this purpose we could implement a generic <code>JobsController&lt;TEndpoint&gt;</code>, which would be bound to specific <em>endpoint</em> via its type parameter <code>TEndpoint</code>.</p>\n<p>As multiple <em>endpoints</em> per service have to be supported, MVC requires providing different underlying type for each controller. This is not possible with our idea of using a generic one, as changing generic’s type parameter does not change overall generic type. Instead, we should create individual controller type from base generic dynamically, using a bit of <a href=\"https://docs.microsoft.com/en-us/dotnet/api/system.reflection.emit.typebuilder\">TypeBuilder</a> reflection magic. Generated types could then be added to MVC using custom <a href=\"https://docs.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.applicationparts.iapplicationparttypeprovider\">IApplicationPartTypeProvider</a>.</p>\n<h3 id=\"Few-words-on-repository-and-queue\"><a href=\"#Few-words-on-repository-and-queue\" class=\"headerlink\" title=\"Few words on repository and queue\"></a>Few words on repository and queue</h3><p>Following how we defined <em>job repository</em> and <em>queue</em>, respecting interfaces would be:</p>\n<script src=\"https://gist.github.com/uveta/44ca3dfbba05536e5091fbc353b611ec.js\"></script>\n<script src=\"https://gist.github.com/uveta/585866e8ae67e75d7c65eac9cccb6d0b.js\"></script>\n\n<p>The pattern has to supply default memory implementation for both of them. Although this should suffice for test and single-service usage, it completely falls flat in any advanced scenarios. Hence, replacing default implementations must be allowed via extensions.</p>\n<h3 id=\"Configuring-job-services\"><a href=\"#Configuring-job-services\" class=\"headerlink\" title=\"Configuring job services\"></a>Configuring job services</h3><p>We should follow principals ASP.NET Core was build upon and adopt a plugin architecture in order to configure our pattern services. I used <a href=\"https://github.com/uveta/extensions-jobs/tree/main/samples/MvcDemo\">a sample project</a> to demonstrate how such behavior could be achieved. The following example includes definition of one <em>endpoint</em> and its bound <em>worker</em>.</p>\n<script src=\"https://gist.github.com/uveta/777c12716df3015ebc67a651916bea23.js\"></script>\n\n<p>In this case, <code>PingRequest</code> and <code>PingResponse</code> correspond to input and output types. <code>PingWorker</code> represents a custom implementation of <code>IWorker</code>, supplied by user. Other components (<em>endpoint</em>, <em>repository</em> and <em>queue</em>) are provided by pattern and only configured here.</p>\n<h2 id=\"Usage-alternatives\"><a href=\"#Usage-alternatives\" class=\"headerlink\" title=\"Usage alternatives\"></a>Usage alternatives</h2><p>Proposed implementation is just one of many possible, as well as its usage. All building blocks are introduced as abstract concepts, which can be adapted for different scenarios than initially intended. For example, an <em>endpoint</em> could be utilized to issue an RPC call without knowing the address of remote service; client would use <em>endpoint</em> to create a new job, which would reach designated <em>worker</em> via queue, effectively removing the need of individual services knowing other ones even exist. Only constraint is imposed by specific business feature, having strictly defined input and output.</p>\n<p>Further improvements can be introduced on <em>workers</em> as well. In order to use them in a real-world scenarios, there has to be a possibility of configuring their maximum scaling and execution period limits. This feature will have to be supported by <em>queue</em> implementation, as <em>worker</em> is invoked based on actions triggered by <em>queue consumer</em>.</p>\n<p>Finally, default memory implementations of <em>queue</em> and <em>repository</em> are only good for <a href=\"https://github.com/uveta/extensions-jobs/tree/main/samples/MvcDemo\">demonstration purposes</a>. <em>Repository</em> should offer some form of permanent external storage, especially if usage in multi-service applications is considered. Same goes for <em>queue</em>, as the need for underlying message broker is evident in even simple production scenarios.</p>\n<h2 id=\"Conclusion\"><a href=\"#Conclusion\" class=\"headerlink\" title=\"Conclusion\"></a>Conclusion</h2><p>In this article I explained which set of problems did we solve using long running job pattern. We also saw one of the ways to implement it, using ASP.NET Core MVC. As a final observation, I described how inner pattern components can be used outside of MVC, in any system that wants to generalize request/response flow and reduce service coupling.</p>\n<p>Source code and samples can be found on <a href=\"https://github.com/uveta/extensions-jobs\">Github</a>. Individual packages have also been published to <a href=\"https://www.nuget.org/packages/Uveta.Extensions.Jobs/\">nuget.org</a>, in case you would like to try them in your own application.</p>\n</body></html>",
            "tags": [
                "advanced",
                "microservices",
                "dotnet"
            ]
        }
    ]
}