<!DOCTYPE html>
<html class="has-navbar-fixed-top">
<head>
    <meta charset="utf-8">
<title>Unclutter Startup.cs - Uveta&#39;s blog</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.css">




<meta name="description" content="Uveta's blog about all things Azure">



<meta name="keywords" content="azure, cloud, microsoft, .net, dotnet, dotnetcore, aspnetcore, csharp, C#, elasticsearch, software, development, containers, docker, kubernetes">



    <meta name="description" content="Configuring service container and setting up request pipeline in ASP.NET Core can eat up a lot of lines of code, especially for more complex projects. A well-established way of doing this is using S">
<meta property="og:type" content="article">
<meta property="og:title" content="Unclutter Startup.cs">
<meta property="og:url" content="https://www.uveta.io/categories/blog/unclutter-startup-cs/index.html">
<meta property="og:site_name" content="Uveta&#39;s blog">
<meta property="og:description" content="Configuring service container and setting up request pipeline in ASP.NET Core can eat up a lot of lines of code, especially for more complex projects. A well-established way of doing this is using S">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://www.uveta.io/categories/blog/unclutter-startup-cs/calendar.jpg">
<meta property="article:published_time" content="2021-12-18T14:00:09.000Z">
<meta property="article:modified_time" content="2021-12-18T14:00:09.000Z">
<meta property="article:author" content="Uroš Miletić">
<meta property="article:tag" content="azure">
<meta property="article:tag" content="advanced">
<meta property="article:tag" content="dotnet">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://www.uveta.io/categories/blog/unclutter-startup-cs/calendar.jpg">




<link rel="alternate" type="application/rss+xml" title="Uveta&#39;s blog" href="https://www.uveta.io/rss.xml" />
<link rel="alternate" type="application/atom+xml" title="Uveta&#39;s blog" href="https://www.uveta.io/atom.xml" />
<link rel="alternate" type="application/json" title="Uveta&#39;s blog" href="https://www.uveta.io/feed.json" />


<link rel="icon" href="/images/logo.svg">


<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ovo|Source+Code+Pro">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bulma/0.6.2/css/bulma.min.css">



<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/atom-one-light.min.css">


<link rel="stylesheet" href="/css/style.css">


<script defer src="//use.fontawesome.com/releases/v5.0.8/js/all.js"></script>


    
    
    
    
    
    
    
    
    
    
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-168901242-1"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-168901242-1');
</script>


    
    
<link rel="stylesheet" type="text/css"
    href="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.css" />



    


<meta name="generator" content="Hexo 5.4.0"></head>
<body>
    
<nav class="navbar is-transparent is-fixed-top navbar-main" role="navigation" aria-label="main navigation">
    <div class="container">
        <div class="navbar-brand">
            <a class="navbar-item navbar-logo" href="/">
                
                    
                    <img src="/images/logo.png" alt="" height="28">
                    
                
            </a>
            <div class="navbar-burger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        
        <div class="navbar-menu navbar-start">
            
            <a class="navbar-item "
               href="/archives">Blog</a>
            
            <a class="navbar-item "
               href="/about">About</a>
            
            <a class="navbar-item "
               href="/contact">Contact</a>
            
        </div>
        
        <div class="navbar-menu navbar-end">
            
            <a class="navbar-item search" title="Search" href="javascript:;">
                <i class="fas fa-search"></i>
            </a>
            
            
            <div class="navbar-item is-hoverable has-dropdown is-hidden-mobile is-hidden-tablet-only toc">
                <a class="navbar-item" title="Table of Contents">
                    <i class="fa fa-list"></i>
                </a>
                <div class="navbar-dropdown is-right">
                    
                    
                    
                    
                    <a class="navbar-item" href="#Basic-principles">1&nbsp;&nbsp;<b>Basic principles</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#MVC">2&nbsp;&nbsp;<b>MVC</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#Authentication">3&nbsp;&nbsp;<b>Authentication</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#Authorization">4&nbsp;&nbsp;<b>Authorization</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#OpenAPI">5&nbsp;&nbsp;<b>OpenAPI</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#Application-Insights">6&nbsp;&nbsp;<b>Application Insights</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#Extras">7&nbsp;&nbsp;<b>Extras</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#Application-code">8&nbsp;&nbsp;<b>Application code</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#Conclusion">9&nbsp;&nbsp;<b>Conclusion</b></a>
                    
                </div>
            </div>
            
            
            <a class="navbar-item" title="GitHub" target="_blank" rel="noopener" href="https://github.com/uveta">
                
                <i class="fab fa-github"></i>
                
            </a>
               
            <a class="navbar-item" title="Twitter" target="_blank" rel="noopener" href="https://twitter.com/uveta">
                
                <i class="fab fa-twitter"></i>
                
            </a>
               
            <a class="navbar-item" title="Linkedin" target="_blank" rel="noopener" href="https://www.linkedin.com/in/uveta">
                
                <i class="fab fa-linkedin"></i>
                
            </a>
               
            
        </div>
    </div>
</nav>

    <section class="section">
    <div class="container">
    <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            Unclutter Startup.cs
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        
        <span class="column is-narrow">
            
                <time datetime="2021-12-18T14:00:09.000Z" itemprop="datePublished">Dec 18 2021</time>
            
        </span>
        
        
        <span class="column is-narrow article-category">
            <i class="far fa-folder"></i>
            <a class="article-category-link" href="/categories/blog/">blog</a>
        </span>
        
        
        <span class="column is-narrow">
            
            
            9 minutes read (About 1411 words)
        </span>
        
    </div>
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <html><head></head><body><img src="/categories/blog/unclutter-startup-cs/calendar.jpg" class="" title="Advent calendar">

<p>Configuring service container and setting up request pipeline in ASP.NET Core can eat up a lot of lines of code, especially for more complex projects. A well-established way of doing this is using <em>Startup.cs</em> and its <code>ConfigureServices()</code> and <code>Configure()</code> methods. Although complete application setup can be packed into a single type, we must not forget about Single-responsibility principle. I wanted to show you a way to prevent startup from growing uncontrollably, by keeping different concerns separate from each other.</p>
<p>One disclaimer though. ASP.NET Core 6 has rolled in and removed the need of having <em>Startup.cs</em> altogether. Despite that fact, I am sure the ideas presented in this post will be relevant, even in the new era.</p>
<span id="more"></span>

<p><em>This post is part of <a target="_blank" rel="noopener" href="https://www.csadvent.christmas/">C# Advent Calendar 2021</a>. Cheers to <a target="_blank" rel="noopener" href="https://twitter.com/mgroves">Matthew D. Groves</a> for letting me participate!</em></p>
<h2 id="Basic-principles"><a href="#Basic-principles" class="headerlink" title="Basic principles"></a>Basic principles</h2><p>We will apply two .NET features: <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/configuration/options">Options pattern</a> and <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/dotnet/csharp/programming-guide/classes-and-structs/extension-methods">Extension methods</a>. Similar to how ASP.NET Core uses plugin architecture, we will utilize these features to separate concerns and leave heavy lifting to dependency injection container.</p>
<p>One design standard, to keep in mind, is that almost all parts of ASP.NET Core are configured via <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.extensions.options.ioptions-1">IOptions<toptions></toptions></a> pattern. And, since all <code>IOptions&lt;TOptions&gt;</code> instances are part of service container, we can use <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/configuration/options#use-di-services-to-configure-options">IConfigureOptions<toptions></toptions></a> or <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/configuration/options#options-post-configuration">IPostConfigureOptions<toptions></toptions></a> to override any one of them.</p>
<h2 id="MVC"><a href="#MVC" class="headerlink" title="MVC"></a>MVC</h2><p>Whether you are using Controllers only, or including Views or Razor Pages, MVC setup is more or less the same. The goal is to call <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.extensions.dependencyinjection.mvcservicecollectionextensions.addcontrollers">AddControllers()</a>, <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.extensions.dependencyinjection.mvcservicecollectionextensions.addcontrollerswithviews">AddControllersWithViews()</a> or <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.extensions.dependencyinjection.mvcservicecollectionextensions.addrazorpages">AddRazorPages()</a>, based on your scenario, and define configuration for <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.mvcoptions">MvcOptions</a>, and possibly <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.razorpages.razorpagesoptions">RazorPagesOptions</a>. If you are using <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/dotnet/api/system.text.json.jsonserializer">System.Text.Json</a> or <a target="_blank" rel="noopener" href="https://www.nuget.org/packages/Microsoft.AspNetCore.Mvc.NewtonsoftJson">Newtonsoft Json.NET</a> for model serialization, you could also configure them in a similar manner. Whole setup would look like this:</p>
<figure class="highlight csharp hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MvcExtensions</span></span><br><span class="line">{</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> IServiceCollection <span class="hljs-title">ConfigureMvc</span>(<span class="hljs-params"><span class="hljs-keyword">this</span> IServiceCollection services</span>)</span></span><br><span class="line">    {</span><br><span class="line">        services.AddControllers().AddNewtonsoftJson();</span><br><span class="line">        services.AddSingleton&lt;IConfigureOptions&lt;MvcOptions&gt;, ConfigureMvcOptions&gt;();</span><br><span class="line">        services.AddSingleton&lt;IConfigureOptions&lt;MvcNewtonsoftJsonOptions&gt;, ConfigureNewtonsoftOptions&gt;();</span><br><span class="line">        <span class="hljs-keyword">return</span> services;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ConfigureMvcOptions</span> : <span class="hljs-title">IConfigureOptions</span>&lt;<span class="hljs-title">MvcOptions</span>&gt;</span><br><span class="line">{</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Configure</span>(<span class="hljs-params">MvcOptions options</span>)</span></span><br><span class="line">    {</span><br><span class="line">        options.SuppressAsyncSuffixInActionNames = <span class="hljs-literal">true</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ConfigureNewtonsoftOptions</span> : <span class="hljs-title">IConfigureOptions</span>&lt;<span class="hljs-title">MvcNewtonsoftJsonOptions</span>&gt;</span><br><span class="line">{</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Configure</span>(<span class="hljs-params">MvcNewtonsoftJsonOptions options</span>)</span></span><br><span class="line">    {</span><br><span class="line">        options.SerializerSettings.Converters.Add(<span class="hljs-keyword">new</span> StringEnumConverter());</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="Authentication"><a href="#Authentication" class="headerlink" title="Authentication"></a>Authentication</h2><p>Completely driving authentication by configuration is difficult. You probably need to know what type of authentication your application uses in advance. Good news is that, once baseline is established, you can use above mentioned technique to configure individual parts. For example, you would use <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.authentication.cookies.cookieauthenticationoptions">CookieAuthenticationOptions</a> to configure cookies, and <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.authentication.jwtbearer.jwtbeareroptions">JwtBearerOptions</a> for token based authentication. Extension and individual configuration options, including an example of injecting IConfiguration into one of them, would look like this:</p>
<figure class="highlight csharp hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title">AuthenticationExtensions</span></span><br><span class="line">{</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> IServiceCollection <span class="hljs-title">ConfigureAuthentication</span>(<span class="hljs-params"><span class="hljs-keyword">this</span> IServiceCollection services</span>)</span></span><br><span class="line">    {</span><br><span class="line">        services.AddAuthentication().AddCookie().AddJwtBearer();</span><br><span class="line">        services.AddSingleton&lt;IConfigureOptions&lt;AuthenticationOptions&gt;, ConfigureAuthenticationOptions&gt;();</span><br><span class="line">        services.AddSingleton&lt;IConfigureOptions&lt;CookieAuthenticationOptions&gt;, ConfigureCookieAuthenticationOptions&gt;();</span><br><span class="line">        services.AddSingleton&lt;IConfigureOptions&lt;JwtBearerOptions&gt;, ConfigureJwtBearerOptions&gt;();</span><br><span class="line">        <span class="hljs-keyword">return</span> services;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ConfigureAuthenticationOptions</span> : <span class="hljs-title">IConfigureOptions</span>&lt;<span class="hljs-title">AuthenticationOptions</span>&gt;</span><br><span class="line">{</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Configure</span>(<span class="hljs-params">AuthenticationOptions options</span>)</span></span><br><span class="line">    {</span><br><span class="line">        options.DefaultAuthenticateScheme = JwtBearerDefaults.AuthenticationScheme;</span><br><span class="line">        options.DefaultChallengeScheme = JwtBearerDefaults.AuthenticationScheme;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ConfigureCookieAuthenticationOptions</span> : <span class="hljs-title">IConfigureOptions</span>&lt;<span class="hljs-title">CookieAuthenticationOptions</span>&gt;</span><br><span class="line">{</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Configure</span>(<span class="hljs-params">CookieAuthenticationOptions options</span>)</span></span><br><span class="line">    {</span><br><span class="line">        options.ExpireTimeSpan = TimeSpan.FromHours(<span class="hljs-number">1</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ConfigureJwtBearerOptions</span> : <span class="hljs-title">IConfigureOptions</span>&lt;<span class="hljs-title">JwtBearerOptions</span>&gt;</span><br><span class="line">{</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> IConfiguration _configuration;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ConfigureJwtBearerOptions</span>(<span class="hljs-params">IConfiguration configuration</span>)</span></span><br><span class="line">    {</span><br><span class="line">        _configuration = configuration;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Configure</span>(<span class="hljs-params">JwtBearerOptions options</span>)</span></span><br><span class="line">    {</span><br><span class="line">        options.Authority = _configuration.GetValue&lt;<span class="hljs-built_in">string</span>&gt;(<span class="hljs-string">"jwt:authority"</span>);</span><br><span class="line">        options.RequireHttpsMetadata = <span class="hljs-literal">false</span>;</span><br><span class="line">        options.IncludeErrorDetails = <span class="hljs-literal">true</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="Authorization"><a href="#Authorization" class="headerlink" title="Authorization"></a>Authorization</h2><p>Configuring authorization can get quite tedious, if number or complexity of policies increases. Luckily, setup process is pretty straightforward, as the only concern is injecting configuration via <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.authorization.authorizationoptions">AuthorizationOptions</a> type.</p>
<figure class="highlight csharp hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title">AuthorizationExtensions</span></span><br><span class="line">{</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> IServiceCollection <span class="hljs-title">ConfigureAuthorization</span>(<span class="hljs-params"><span class="hljs-keyword">this</span> IServiceCollection services</span>)</span></span><br><span class="line">    {</span><br><span class="line">        services.AddAuthorization();</span><br><span class="line">        services.AddSingleton&lt;IConfigureOptions&lt;AuthorizationOptions&gt;, ConfigureAuthorizationOptions&gt;();</span><br><span class="line">        <span class="hljs-keyword">return</span> services;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ConfigureAuthorizationOptions</span> : <span class="hljs-title">IConfigureOptions</span>&lt;<span class="hljs-title">AuthorizationOptions</span>&gt;</span><br><span class="line">{</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Configure</span>(<span class="hljs-params">AuthorizationOptions options</span>)</span></span><br><span class="line">    {</span><br><span class="line">        options.DefaultPolicy = <span class="hljs-keyword">new</span> AuthorizationPolicyBuilder().RequireAuthenticatedUser().Build();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="OpenAPI"><a href="#OpenAPI" class="headerlink" title="OpenAPI"></a>OpenAPI</h2><p>If you care about your REST API consumers, you are publishing service description, using OpenAPI specification. And, since we are talking about ASP.NET Core, you are probably using awesome <a target="_blank" rel="noopener" href="https://www.nuget.org/packages/Swashbuckle.AspNetCore">Swashbuckle</a> package. As with previously mentioned framework parts, this extension was designed on same principles, and can be setup in a similar fashion. Whether its generating definition file using <code>SwaggerGenOptions</code>, or adjusting swagger user interface via <code>SwaggerUIOptions</code>, everything can be broken down and put into separate types.</p>
<figure class="highlight csharp hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title">OpenApiExtensions</span></span><br><span class="line">{</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> IServiceCollection <span class="hljs-title">ConfigureOpenApi</span>(<span class="hljs-params"><span class="hljs-keyword">this</span> IServiceCollection services</span>)</span></span><br><span class="line">    {</span><br><span class="line">        services.AddSwaggerGen();</span><br><span class="line">        services.AddSwaggerGenNewtonsoftSupport();</span><br><span class="line">        services.AddSingleton&lt;IConfigureOptions&lt;SwaggerGenOptions&gt;, ConfigureSwaggerGenOptions&gt;();</span><br><span class="line">        services.AddSingleton&lt;IConfigureOptions&lt;SwaggerOptions&gt;, ConfigureSwaggerOptions&gt;();</span><br><span class="line">        services.AddSingleton&lt;IConfigureOptions&lt;SwaggerUIOptions&gt;, ConfigureSwaggerUiOptions&gt;();</span><br><span class="line">        <span class="hljs-keyword">return</span> services;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ConfigureSwaggerGenOptions</span> : <span class="hljs-title">IConfigureOptions</span>&lt;<span class="hljs-title">SwaggerGenOptions</span>&gt;</span><br><span class="line">{</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Configure</span>(<span class="hljs-params">SwaggerGenOptions options</span>)</span></span><br><span class="line">    {</span><br><span class="line">        options.SwaggerDoc(<span class="hljs-string">"v1"</span>, <span class="hljs-keyword">new</span> OpenApiInfo { Title = <span class="hljs-string">"Demo"</span>, Version = <span class="hljs-string">"v1"</span> });</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ConfigureSwaggerOptions</span> : <span class="hljs-title">IConfigureOptions</span>&lt;<span class="hljs-title">SwaggerOptions</span>&gt;</span><br><span class="line">{</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Configure</span>(<span class="hljs-params">SwaggerOptions options</span>)</span></span><br><span class="line">    {</span><br><span class="line">        options.RouteTemplate = <span class="hljs-string">"swagger/{documentName}/swagger.json"</span>;</span><br><span class="line">        options.PreSerializeFilters.Add((swaggerDoc, httpReq) =&gt;</span><br><span class="line">        {</span><br><span class="line">            swaggerDoc.Servers = <span class="hljs-keyword">new</span>[] {</span><br><span class="line">                <span class="hljs-keyword">new</span> OpenApiServer {</span><br><span class="line">                    Url = <span class="hljs-string">$"<span class="hljs-subst">{httpReq.Scheme}</span>://<span class="hljs-subst">{httpReq.Host.Value}</span><span class="hljs-subst">{httpReq.PathBase}</span>"</span>,</span><br><span class="line">                    Description = <span class="hljs-string">"Default"</span></span><br><span class="line">                }</span><br><span class="line">            };</span><br><span class="line">        });</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ConfigureSwaggerUiOptions</span> : <span class="hljs-title">IConfigureOptions</span>&lt;<span class="hljs-title">SwaggerUIOptions</span>&gt;</span><br><span class="line">{</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Configure</span>(<span class="hljs-params">SwaggerUIOptions options</span>)</span></span><br><span class="line">    {</span><br><span class="line">        options.SwaggerEndpoint(<span class="hljs-string">"/swagger/v1/swagger.json"</span>, <span class="hljs-string">"Demo v1"</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="Application-Insights"><a href="#Application-Insights" class="headerlink" title="Application Insights"></a>Application Insights</h2><p>How about some Azure extensions? Most of the time you will not even need them, as ASP.NET Core seamlessly integrates with most of Azure resources. However, one particular extension I recommend using are <a target="_blank" rel="noopener" href="https://www.nuget.org/packages/Microsoft.ApplicationInsights.AspNetCore">Application Insights</a>. You want to have application telemetry under control, and this package allows you to fine tune metrics and data that will be ingested by Azure. From setup point of view, there is nothing surprising:</p>
<figure class="highlight csharp hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title">TelemetryExtensions</span></span><br><span class="line">{</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> IServiceCollection <span class="hljs-title">ConfigureTelemetry</span>(<span class="hljs-params"><span class="hljs-keyword">this</span> IServiceCollection services</span>)</span></span><br><span class="line">    {</span><br><span class="line">        services.AddApplicationInsightsTelemetry();</span><br><span class="line">        services.AddSingleton&lt;IConfigureOptions&lt;ApplicationInsightsServiceOptions&gt;, ConfigureApplicationInsights&gt;();</span><br><span class="line">        <span class="hljs-keyword">return</span> services;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ConfigureApplicationInsights</span> : <span class="hljs-title">IConfigureOptions</span>&lt;<span class="hljs-title">ApplicationInsightsServiceOptions</span>&gt;</span><br><span class="line">{</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Configure</span>(<span class="hljs-params">ApplicationInsightsServiceOptions options</span>)</span></span><br><span class="line">    {</span><br><span class="line">        options.EnableHeartbeat = <span class="hljs-literal">true</span>;</span><br><span class="line">        options.EnableAppServicesHeartbeatTelemetryModule = <span class="hljs-literal">true</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="Extras"><a href="#Extras" class="headerlink" title="Extras"></a>Extras</h2><p>You’ve probably gotten the gist of it by now; use extension methods to extract service definitions, and options to do actual service configuration. For completeness, let me give you the rest of commonly used ASP.NET Core features, including types used for configuration.</p>
<ul>
<li>Default files middleware via <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.defaultfilesextensions.usedefaultfiles">UseDefaultFiles()</a> - <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.defaultfilesoptions">DefaultFilesOptions</a></li>
<li>Static files middleware via <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.staticfileextensions.usestaticfiles">UseStaticFiles()</a> - <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.staticfileoptions">StaticFileOptions</a></li>
<li>Cross-Origin Resource Sharing via <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.extensions.dependencyinjection.corsservicecollectionextensions.addcors">AddCors()</a> - <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.cors.infrastructure.corsoptions?view=aspnetcore-6.0">CorsOptions</a></li>
<li>API Versioning services via <a target="_blank" rel="noopener" href="https://www.nuget.org/packages/Microsoft.AspNetCore.Mvc.Versioning">AddApiVersioning() and AddVersionedApiExplorer()</a> - <a target="_blank" rel="noopener" href="https://github.com/dotnet/aspnet-api-versioning/blob/master/src/Microsoft.AspNetCore.Mvc.Versioning.ApiExplorer/ApiExplorerOptions.cs">ApiExplorerOptions</a> and <a target="_blank" rel="noopener" href="https://github.com/dotnet/aspnet-api-versioning/blob/master/src/Common/Versioning/ApiVersioningOptions.cs">ApiVersioningOptions</a></li>
</ul>
<h2 id="Application-code"><a href="#Application-code" class="headerlink" title="Application code"></a>Application code</h2><p>Last but not least, what about your own application code? I highly recommend following the same principles, in order to avoid having application setup in a single place. If you are using clean architecture, and have your code decoupled into layers, initialization could be as simple as:</p>
<figure class="highlight csharp hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ApplicationExtensions</span></span><br><span class="line">{</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> IServiceCollection <span class="hljs-title">ConfigureApplication</span>(<span class="hljs-params"><span class="hljs-keyword">this</span> IServiceCollection services</span>)</span></span><br><span class="line">    {</span><br><span class="line">        services</span><br><span class="line">            .AddDomain()</span><br><span class="line">            .AddApplicationServices()</span><br><span class="line">            .AddRepositories()</span><br><span class="line">            .AddIntegration();</span><br><span class="line">        <span class="hljs-keyword">return</span> services;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>I have shown you one neat little trick that I use all the time, when setting up any kind of application. It is important to remember Single-responsibility principle, even for this type of code. Having <em>Startup.cs</em> consisting of several hundreds, or even thousands lines, is nothing unheard of. And, sadly, is an obvious code smell.</p>
<p>All code shown in this post was published to <a target="_blank" rel="noopener" href="https://github.com/uveta/demo-unclutter-startup">GitHub</a>, as a single ASP.NET Core 6 project.</p>
</body></html>
    
    </div>
    
    <div class="columns is-variable is-1 is-multiline is-mobile">
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/tags/azure/">#azure</a></span>
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/tags/advanced/">#advanced</a></span>
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/tags/dotnet/">#dotnet</a></span>
    
    </div>
    
    
    <div class="columns is-mobile is-multiline article-nav">
        <span class="column is-12-mobile is-half-desktop is-hidden-mobile article-nav-prev">
            
        </span>
        <span class="column is-12-mobile is-half-desktop  article-nav-next">
            
            <a href="/categories/blog/asynchronous-job-pattern-the-asp-net-core-mvc-way/">Asynchronous Job Pattern - The ASP.NET Core MVC Way</a>
            
        </span>
    </div>
    
</article>




<div class="comments">
    <h3 class="title is-4">Comments</h3>
    
<script>
    var disqus_config = function () {
        this.page.url = 'https://www.uveta.io/categories/blog/unclutter-startup-cs/';
        this.page.identifier = 'unclutter-startup-cs';
        
        this.language = 'en';
        
    };
    (function() {
        var d = document, s = d.createElement('script');  
        s.src = '//' + 'uveta-github-io' + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>

<div id="disqus_thread">
    
    <noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
</div>

    </div>
</section>
    <footer class="footer">
    <div class="container">
        <div class="columns content">
            <div class="column is-narrow has-text-centered">
                &copy; 2022 Uroš Miletić&nbsp;
                Powered by <a href="https://hexo.io/" target="_blank" rel="noreferrer noopener">Hexo</a> & <a
                        target="_blank" rel="noopener" href="https://github.com/ppoffice/hexo-theme-minos">Minos</a>
            </div>
            <div class="column is-hidden-mobile"></div>

            
            <div class="column is-narrow">
                <div class="columns is-mobile is-multiline is-centered">
                
                    
                <a class="column is-narrow has-text-black" title="GitHub" target="_blank" rel="noopener" href="https://github.com/uveta/uveta.github.io">
                    
                    GitHub
                    
                </a>
                
                </div>
            </div>
            
            
        </div>
    </div>
</footer>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script>

<!-- test if the browser is outdated -->
<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" target="_blank" rel="noopener" href="http://outdatedbrowser.com/">Update my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="//cdnjs.cloudflare.com/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.js"></script>
<script>
    $(document).ready(function () {
        // plugin function, place inside DOM ready function
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        })
    });
</script>

<script>
    window.FontAwesomeConfig = {
        searchPseudoElements: true
    }
    moment.locale("en-AU");
</script>


    
    
    
    
    
    
    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
    <style>
        .hljs {
            position: relative;
        }

        .hljs .clipboard-btn {
            float: right;
            color: #9a9a9a;
            background: none;
            border: none;
            cursor: pointer;
        }

        .hljs .clipboard-btn:hover {
          color: #8a8a8a;
        }

        .hljs > .clipboard-btn {
            display: none;
            position: absolute;
            right: 4px;
            top: 4px;
        }

        .hljs:hover > .clipboard-btn {
            display: inline;
        }

        .hljs > figcaption > .clipboard-btn {
            margin-right: 4px;
        }
    </style>
    <script>
      $(document).ready(function () {
        $('figure.hljs').each(function(i, figure) {
          var codeId = 'code-' + i;
          var code = figure.querySelector('.code');
          var copyButton = $('<button>Copy <i class="far fa-clipboard"></i></button>');
          code.id = codeId;
          copyButton.addClass('clipboard-btn');
          copyButton.attr('data-clipboard-target-id', codeId);

          var figcaption = figure.querySelector('figcaption');

          if (figcaption) {
            figcaption.append(copyButton[0]);
          } else {
            figure.prepend(copyButton[0]);
          }
        })

        var clipboard = new ClipboardJS('.clipboard-btn', {
          target: function(trigger) {
            return document.getElementById(trigger.getAttribute('data-clipboard-target-id'));
          }
        });
        clipboard.on('success', function(e) {
          e.clearSelection();
        })
      })
    </script>

    
    

    
    


<script src="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.js" data-cfasync="false"></script>
<script>
    window.cookieconsent.initialise({
        "palette": {
            "popup": {
                "background": "#3273dc"
            },
            "button": {
                "background": "#fff",
                "text": "#3273dc"
            }
        }
    });
</script>

    



<script src="/js/script.js"></script>


    
    <div class="searchbox ins-search">
    <div class="searchbox-mask"></div>
    <div class="searchbox-container ins-search-container">
        <div class="searchbox-input-wrapper">
            <input type="text" class="searchbox-input ins-search-input" placeholder="Type something..." />
            <span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="searchbox-result-wrapper ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: 'Posts',
                PAGES: 'Pages',
                CATEGORIES: 'Categories',
                TAGS: 'Tags',
                UNTITLED: '(Untitled)',
            },
            CONTENT_URL: '/content.json',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>

<script src="/js/insight.js"></script>

    
</body>
</html>