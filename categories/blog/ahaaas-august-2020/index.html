<!DOCTYPE html>
<html class="has-navbar-fixed-top">
<head>
    <meta charset="utf-8">
<title>Ahaaas! - August 2020 - Uveta&#39;s blog</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.css">




<meta name="description" content="Uveta's blog about all things Azure">



<meta name="keywords" content="azure, cloud, microsoft, .net, dotnet, dotnetcore, aspnetcore, csharp, C#, elasticsearch, software, development, containers, docker, kubernetes">



    <meta name="description" content="New month, new exciting moments from my life as a developer. I hope you will enjoy reading about these flashes of clarity, that come suddenly after solving unfamiliar problems. Or as I like to call">
<meta property="og:type" content="article">
<meta property="og:title" content="Ahaaas! - August 2020">
<meta property="og:url" content="https://www.uveta.io/categories/blog/ahaaas-august-2020/index.html">
<meta property="og:site_name" content="Uveta&#39;s blog">
<meta property="og:description" content="New month, new exciting moments from my life as a developer. I hope you will enjoy reading about these flashes of clarity, that come suddenly after solving unfamiliar problems. Or as I like to call">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://www.uveta.io/categories/blog/ahaaas-august-2020/cartoon-1294877.png">
<meta property="article:published_time" content="2020-09-05T07:32:56.000Z">
<meta property="article:modified_time" content="2020-09-05T07:32:56.000Z">
<meta property="article:author" content="Uroš Miletić">
<meta property="article:tag" content="azure">
<meta property="article:tag" content="advanced">
<meta property="article:tag" content=".net">
<meta property="article:tag" content="csharp">
<meta property="article:tag" content="containers">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://www.uveta.io/categories/blog/ahaaas-august-2020/cartoon-1294877.png">




<link rel="alternate" type="application/rss+xml" title="Uveta&#39;s blog" href="https://www.uveta.io/rss.xml" />
<link rel="alternate" type="application/atom+xml" title="Uveta&#39;s blog" href="https://www.uveta.io/atom.xml" />
<link rel="alternate" type="application/json" title="Uveta&#39;s blog" href="https://www.uveta.io/feed.json" />


<link rel="icon" href="/images/logo.svg">


<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ovo|Source+Code+Pro">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bulma/0.6.2/css/bulma.min.css">



<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/atom-one-light.min.css">


<link rel="stylesheet" href="/css/style.css">


<script defer src="//use.fontawesome.com/releases/v5.0.8/js/all.js"></script>


    
    
    
    
    
    
    
    
    
    
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-168901242-1"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-168901242-1');
</script>


    
    
<link rel="stylesheet" type="text/css"
    href="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.css" />



    


<meta name="generator" content="Hexo 5.4.0"></head>
<body>
    
<nav class="navbar is-transparent is-fixed-top navbar-main" role="navigation" aria-label="main navigation">
    <div class="container">
        <div class="navbar-brand">
            <a class="navbar-item navbar-logo" href="/">
                
                    
                    <img src="/images/logo.png" alt="" height="28">
                    
                
            </a>
            <div class="navbar-burger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        
        <div class="navbar-menu navbar-start">
            
            <a class="navbar-item "
               href="/archives">Blog</a>
            
            <a class="navbar-item "
               href="/about">About</a>
            
            <a class="navbar-item "
               href="/contact">Contact</a>
            
        </div>
        
        <div class="navbar-menu navbar-end">
            
            <a class="navbar-item search" title="Search" href="javascript:;">
                <i class="fas fa-search"></i>
            </a>
            
            
            <div class="navbar-item is-hoverable has-dropdown is-hidden-mobile is-hidden-tablet-only toc">
                <a class="navbar-item" title="Table of Contents">
                    <i class="fa fa-list"></i>
                </a>
                <div class="navbar-dropdown is-right">
                    
                    
                    
                    
                    <a class="navbar-item" href="#NET">1&nbsp;&nbsp;<b>.NET</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#Azure">2&nbsp;&nbsp;<b>Azure</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#Containers">3&nbsp;&nbsp;<b>Containers</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#Miscellaneous">4&nbsp;&nbsp;<b>Miscellaneous</b></a>
                    
                </div>
            </div>
            
            
            <a class="navbar-item" title="GitHub" target="_blank" rel="noopener" href="https://github.com/uveta">
                
                <i class="fab fa-github"></i>
                
            </a>
               
            <a class="navbar-item" title="Twitter" target="_blank" rel="noopener" href="https://twitter.com/uveta">
                
                <i class="fab fa-twitter"></i>
                
            </a>
               
            <a class="navbar-item" title="Linkedin" target="_blank" rel="noopener" href="https://www.linkedin.com/in/uveta">
                
                <i class="fab fa-linkedin"></i>
                
            </a>
               
            
        </div>
    </div>
</nav>

    <section class="section">
    <div class="container">
    <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            Ahaaas! - August 2020
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        
        <span class="column is-narrow">
            
                <time datetime="2020-09-05T07:32:56.000Z" itemprop="datePublished">Sep 5 2020</time>
            
        </span>
        
        
        <span class="column is-narrow article-category">
            <i class="far fa-folder"></i>
            <a class="article-category-link" href="/categories/blog/">blog</a>
        </span>
        
        
        <span class="column is-narrow">
            
            
            8 minutes read (About 1132 words)
        </span>
        
    </div>
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <html><head></head><body><img src="/categories/blog/ahaaas-august-2020/cartoon-1294877.png" class="" title="Eureka">

<p>New month, new exciting moments from my life as a developer. I hope you will enjoy reading about these flashes of clarity, that come suddenly after solving unfamiliar problems. Or as I like to call them - Ahaaas!</p>
<span id="more"></span>

<h3 id="NET"><a href="#NET" class="headerlink" title=".NET"></a>.NET</h3><ul>
<li><p>Instead of using <code>BlockingCollection</code>, recommended implementation of producer/consumer pattern for .NET Core should utilize <a target="_blank" rel="noopener" href="https://devblogs.microsoft.com/dotnet/an-introduction-to-system-threading-channels/">Channels</a>. Besides granting full control of number of consumers, it is completely asynchronous and does not lead to thread blocking.</p>
</li>
<li><p>If writing a custom ASP.NET Core middleware, pay attention how scoped services are injected. As middlewares are registered as singletons, scoped services cannot be injected via constructor <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/middleware/write#middleware-dependencies">https://docs.microsoft.com/en-us/aspnet/core/fundamentals/middleware/write#middleware-dependencies</a>.</p>
</li>
<li><p>There is no simple way to resolve implementations of <code>IHostedService</code> or <code>BackgroundService</code> from DI container. Event though hosted services should not be injected into other services, if you absolutely need to, you can do one of the following (ordered by recommendation, from “yes, please” to “why would you do that”):</p>
<ul>
<li>Do not implement <code>IHostedService</code> directly, but create a hosted wrapper which injects your service and activates it on start; inject service elsewhere and not the hosted wrapper.</li>
<li>Register service both as hosted service and a singleton; same instance will be resolved when injecting.</li>
<li>Inject <code>IEnumerable&lt;IHostedService&gt;</code> and use LINQ to find instance by concrete type.</li>
</ul>
</li>
<li><p>Use the following pattern if you require your event publisher to wait for asynchronous consumers. This can prove useful in case you are testing event driven units and require consumers to complete execution before code following publisher invocation continues. Another example is having application shutdown event, which could wait for consumers before exiting gracefully. Source code was obtained from <a target="_blank" rel="noopener" href="https://stackoverflow.com/">Stack Overflow</a> but for the life of me I could not find the original question again, hence no direct link :(</p>
</li>
</ul>
<figure class="highlight cs hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-keyword">event</span> Func&lt;T, Task&gt; ItemQueued;</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">OnNewItemAsync</span>(<span class="hljs-params">T item</span>)</span></span><br><span class="line">{</span><br><span class="line">    <span class="hljs-keyword">if</span> (ItemQueued <span class="hljs-keyword">is</span> <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span>;</span><br><span class="line">    Func&lt;T, Task&gt; handler = ItemQueued;</span><br><span class="line">    Delegate[] invocationList = handler.GetInvocationList();</span><br><span class="line">    Task[] handlerTasks = <span class="hljs-keyword">new</span> Task[invocationList.Length];</span><br><span class="line">    <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; invocationList.Length; i++)</span><br><span class="line">    {</span><br><span class="line">      handlerTasks[i] = ((Func&lt;T, Task&gt;)invocationList[i])(item);</span><br><span class="line">    }</span><br><span class="line">    <span class="hljs-keyword">await</span> Task.WhenAll(handlerTasks);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li><p>When developing server side Blazor application, HTML markup cannot be changed without having to rebuild the whole application. As this is something naturally supported by other SPA frameworks, you can achieve similar behaviour by running application with <em>dotnet watch run</em>. It will react to any change in source files, re-build and re-run application. It is not a perfect method in any way, but removes the need to manually stop, build and run every time.</p>
</li>
<li><p>If you use Visual Studio you can have <a target="_blank" rel="noopener" href="https://chrissainty.com/get-some-sass-into-your-blazor-app/">Sass in Blazor</a>! It can be achieved by installing an extension and including a specific NuGet package to projects with <em>.scss</em> files. In VS Code, you can use <a target="_blank" rel="noopener" href="https://github.com/ritwickdey/vscode-live-sass-compiler">Live Sass Compiler</a> extension.</p>
</li>
<li><p>Having trouble finding NuGet package storage and caches on your PC? Just use <em>dotnet nuget locals all –list</em> to show all relevant paths. Documentation about additional commands for managing NuGet sources can be found <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/nuget/consume-packages/managing-the-global-packages-and-cache-folders">here</a>.</p>
</li>
<li><p>Selective testing using <em>dotnet test --filter</em> argument <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/dotnet/core/testing/selective-unit-tests?pivots=xunit">https://docs.microsoft.com/en-us/dotnet/core/testing/selective-unit-tests?pivots=xunit</a>.</p>
</li>
<li><p>Even though health checks were introduced in ASP.NET Core 2.2, there are certain issues with initial implementation. Majority of them, mostly related to <code>IHealthCheckPublisher</code> host service and options, were fixed in version 3.0. But, if you are still using 2.2, you might want to check <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/aspnet/core/host-and-deploy/health-checks?view=aspnetcore-2.2#health-check-publisher-1">issue description and workarounds</a>.</p>
</li>
</ul>
<h3 id="Azure"><a href="#Azure" class="headerlink" title="Azure"></a>Azure</h3><ul>
<li><p>Even if you don’t think you’d need it, I recommend turning on soft delete on all blob storages, for at least a period of 7 days. It is one of few features that can protect you from accidental blob removal, as blob storage is currently not supported by Azure Backup. More details on how to enable this option can be found in <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/storage/blobs/soft-delete-enable">official documentation</a>.</p>
</li>
<li><p>In order to test timer triggered Azure Functions, Portal can be used to manually invoke them. From the blade of your Function App, go to Functions, select specific function by name, go to Code + Test and click Test\Run button. Function will be immediately invoked and you can even check its log output.</p>
</li>
<li><p>If you used official template to deploy Elasticsearch cluster to Azure, be sure to replace data disks on each node. They are deployed as standard HDD by default, but I would recommend using standard or, even better, premium SSD. The price difference is negligible, if you are not using very large disks. Obvious benefit is having query response time reduced by approximately 50%. To replace the disk, simply power down node VM, select data disk from Disks blade and switch it to SSD directly from Portal. Repeat for each node in your cluster.</p>
</li>
<li><p>When consuming Azure Service Bus queues/subscriptions, make sure MaxAutoRenewDuration is greater than LockDuration. As best practice, you should leave LockDuration to its default value of 1 minute, and set MaxAutoRenewDuration to maximum time it can take your consumer to process 1 message. If you want to learn more on how Service Bus consumers handle message locking, check <a target="_blank" rel="noopener" href="https://stackoverflow.com/a/60381046">this great answer on Stack Overflow</a>.</p>
</li>
</ul>
<h3 id="Containers"><a href="#Containers" class="headerlink" title="Containers"></a>Containers</h3><ul>
<li><p>Found a great online workshop showcasing Docker and Kubernetes for .NET developers <a target="_blank" rel="noopener" href="https://dak4.net/">https://dak4.net</a>.</p>
</li>
<li><p>Virtual Kubelet for Azure Container Instances does not support pod liveness, readiness or startup checks <a target="_blank" rel="noopener" href="https://github.com/virtual-kubelet/azure-aci">https://github.com/virtual-kubelet/azure-aci</a>. This can seriously limit its usage in production scenarios, as Kubernetes service will not be able to determine pod health. I recommend using ACI kubelet only for bursts of short-running operations. As a bonus piece of information, you can have only 100 ACI instances per subscription, which means virtual kubelet can handle maximum of 100 pods.</p>
</li>
<li><p>At the moment it is not possible to turn off performance monitoring for Azure Kubernetes Service. Collection of various logs can be tweaked, but performance telemetry cannot be configured in any way. This can result in not so small charges for data ingested in Log Analytics, especially if running lots of pods, as telemetry is gathered for every single one of them. Only option is to <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/azure-monitor/insights/container-insights-optout">disable monitoring altogether</a>.</p>
</li>
</ul>
<h3 id="Miscellaneous"><a href="#Miscellaneous" class="headerlink" title="Miscellaneous"></a>Miscellaneous</h3><ul>
<li><p>Ever wished you could develop in emojis? Now you can <a target="_blank" rel="noopener" href="https://www.emojicode.org/">https://www.emojicode.org/</a>.</p>
</li>
<li><p>Great explanation of Linux filesystem and usage of various directories found in root path <a target="_blank" rel="noopener" href="https://www.howtogeek.com/117435/htg-explains-the-linux-directory-structure-explained/">https://www.howtogeek.com/117435/htg-explains-the-linux-directory-structure-explained/</a>. If you ever wondered what are /bin, /etc, /usr directories used for, look no further.</p>
</li>
<li><p>GitHub is launching its own <a target="_blank" rel="noopener" href="https://github.blog/2020-09-01-introducing-github-container-registry/">Container Registry</a>! At the moment, they are just missing their own Kubernetes offering to close development and deployment circle.</p>
</li>
</ul>
</body></html>
    
    </div>
    
    <div class="columns is-variable is-1 is-multiline is-mobile">
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/tags/azure/">#azure</a></span>
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/tags/advanced/">#advanced</a></span>
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/tags/net/">#.net</a></span>
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/tags/csharp/">#csharp</a></span>
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/tags/containers/">#containers</a></span>
    
    </div>
    
    
    <div class="columns is-mobile is-multiline article-nav">
        <span class="column is-12-mobile is-half-desktop  article-nav-prev">
            
            <a href="/categories/blog/azure-functions-deep-dive/">Azure Functions Deep Dive</a>
            
        </span>
        <span class="column is-12-mobile is-half-desktop  article-nav-next">
            
            <a href="/categories/blog/azure-solutions-architect-expert-part-2/">So you want to be an Azure Solutions Architect Expert - Part 2</a>
            
        </span>
    </div>
    
</article>




<div class="comments">
    <h3 class="title is-4">Comments</h3>
    
<script>
    var disqus_config = function () {
        this.page.url = 'https://www.uveta.io/categories/blog/ahaaas-august-2020/';
        this.page.identifier = 'ahaaas-august-2020';
        
        this.language = 'en';
        
    };
    (function() {
        var d = document, s = d.createElement('script');  
        s.src = '//' + 'uveta-github-io' + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>

<div id="disqus_thread">
    
    <noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
</div>

    </div>
</section>
    <footer class="footer">
    <div class="container">
        <div class="columns content">
            <div class="column is-narrow has-text-centered">
                &copy; 2022 Uroš Miletić&nbsp;
                Powered by <a href="https://hexo.io/" target="_blank" rel="noreferrer noopener">Hexo</a> & <a
                        target="_blank" rel="noopener" href="https://github.com/ppoffice/hexo-theme-minos">Minos</a>
            </div>
            <div class="column is-hidden-mobile"></div>

            
            <div class="column is-narrow">
                <div class="columns is-mobile is-multiline is-centered">
                
                    
                <a class="column is-narrow has-text-black" title="GitHub" target="_blank" rel="noopener" href="https://github.com/uveta/uveta.github.io">
                    
                    GitHub
                    
                </a>
                
                </div>
            </div>
            
            
        </div>
    </div>
</footer>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script>

<!-- test if the browser is outdated -->
<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" target="_blank" rel="noopener" href="http://outdatedbrowser.com/">Update my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="//cdnjs.cloudflare.com/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.js"></script>
<script>
    $(document).ready(function () {
        // plugin function, place inside DOM ready function
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        })
    });
</script>

<script>
    window.FontAwesomeConfig = {
        searchPseudoElements: true
    }
    moment.locale("en-AU");
</script>


    
    
    
    
    
    
    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
    <style>
        .hljs {
            position: relative;
        }

        .hljs .clipboard-btn {
            float: right;
            color: #9a9a9a;
            background: none;
            border: none;
            cursor: pointer;
        }

        .hljs .clipboard-btn:hover {
          color: #8a8a8a;
        }

        .hljs > .clipboard-btn {
            display: none;
            position: absolute;
            right: 4px;
            top: 4px;
        }

        .hljs:hover > .clipboard-btn {
            display: inline;
        }

        .hljs > figcaption > .clipboard-btn {
            margin-right: 4px;
        }
    </style>
    <script>
      $(document).ready(function () {
        $('figure.hljs').each(function(i, figure) {
          var codeId = 'code-' + i;
          var code = figure.querySelector('.code');
          var copyButton = $('<button>Copy <i class="far fa-clipboard"></i></button>');
          code.id = codeId;
          copyButton.addClass('clipboard-btn');
          copyButton.attr('data-clipboard-target-id', codeId);

          var figcaption = figure.querySelector('figcaption');

          if (figcaption) {
            figcaption.append(copyButton[0]);
          } else {
            figure.prepend(copyButton[0]);
          }
        })

        var clipboard = new ClipboardJS('.clipboard-btn', {
          target: function(trigger) {
            return document.getElementById(trigger.getAttribute('data-clipboard-target-id'));
          }
        });
        clipboard.on('success', function(e) {
          e.clearSelection();
        })
      })
    </script>

    
    

    
    


<script src="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.js" data-cfasync="false"></script>
<script>
    window.cookieconsent.initialise({
        "palette": {
            "popup": {
                "background": "#3273dc"
            },
            "button": {
                "background": "#fff",
                "text": "#3273dc"
            }
        }
    });
</script>

    



<script src="/js/script.js"></script>


    
    <div class="searchbox ins-search">
    <div class="searchbox-mask"></div>
    <div class="searchbox-container ins-search-container">
        <div class="searchbox-input-wrapper">
            <input type="text" class="searchbox-input ins-search-input" placeholder="Type something..." />
            <span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="searchbox-result-wrapper ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: 'Posts',
                PAGES: 'Pages',
                CATEGORIES: 'Categories',
                TAGS: 'Tags',
                UNTITLED: '(Untitled)',
            },
            CONTENT_URL: '/content.json',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>

<script src="/js/insight.js"></script>

    
</body>
</html>